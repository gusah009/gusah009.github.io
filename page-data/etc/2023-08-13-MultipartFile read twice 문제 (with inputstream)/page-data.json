{"componentChunkName":"component---src-templates-post-template-tsx","path":"/etc/2023-08-13-MultipartFile read twice 문제 (with inputstream)/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><strong>오늘은 MultipartFile에서 InputStream을 다루다가 생긴 문제에 대해서 공유해볼까 합니다.</strong></p>\n<p>키퍼라는 동아리에서 개발을 하던 도중에 갑자기 썸네일 등록이 안되는 문제를 발견했습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271755853-a4ca96c9-ec17-4c7b-b3e1-0a14c95917b4.png\" alt=\"image\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271755859-524c77eb-efe8-40d0-af77-9b00abc04cd0.png\" alt=\"image\"></p>\n<p>서버 로직의 문제일 경우 5xx 에러가 내려가기 때문에 제 로직의 문제일 가능성이 컸습니다.</p>\n<blockquote>\n<p>사용자 요청의 문제일 경우 4xx 가 내려갑니다.</p>\n</blockquote>\n<h2>키퍼 썸네일 유틸리티</h2>\n<p>썸네일 개발은 제 담당이었기 때문에 바로 로그를 찾아봤습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271755758-b5323221-c4bc-4383-a4e8-8bf83a261f68.png\" alt=\"image\"></p>\n<p>세상에 <code class=\"language-text\">/private/var/folders/…</code> 라니… 도대체 저게 무슨 경로인가요…</p>\n<p>찾아봤더니, <code class=\"language-text\">Spring</code>은 파일을 request로 받아서 저장할 때 <code class=\"language-text\">MultipartFile</code>이란 객체를 사용하는데, 이 객체에 담기는 <strong>실제 파일 데이터를 임시로 저장하는 곳이라고 합니다.</strong></p>\n<p><code class=\"language-text\">NoSuchFileException</code> 이란 뜻은 저 실제 파일 데이터가 없어졌다는걸까요?</p>\n<p>그래서 한 번 디버깅을 돌려봤습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271755762-7d16efa3-02b1-4396-9e89-fa7055417d27.png\" alt=\"image\"></p>\n<p>오른쪽 시간을 보면 둘 다 16:35:44에 <code class=\"language-text\">ls</code> 명령어를 입력했는데, 실시간으로 <strong>05</strong> 파일이 없어지는걸 볼 수 있었습니다.</p>\n<blockquote>\n<p><em>04, 06, 07 파일은 요청시에 함께 올린 썸네일이 아닌 다른 파일들입니다.</em></p>\n</blockquote>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271756043-ba8870e0-380e-4073-b2c7-346bad2f8192.png\" alt=\"image\"></p>\n<p>일단 문제가 생긴 곳은 위 부분이었습니다.</p>\n<p><code class=\"language-text\">MultipartFile</code>의 <code class=\"language-text\">InputStream</code> 데이터를 가지고 와서 이미지 유틸리티인 <code class=\"language-text\">ImageIO</code>에 넣어주는 간단한 코드인데, 여기서 저 파일을 찾을 수 없다는 에러가 뜬 것입니다.</p>\n<p>원인은 바로 위 <code class=\"language-text\">trySave</code> 메서드의 <code class=\"language-text\">checkInvalidImageFile</code>에 있었는데, <code class=\"language-text\">checkInvalidImageFile</code>을 한 번 보겠습니다.</p>\n<blockquote>\n<p><em><code class=\"language-text\">checkInvalidImageFile</code>: 유효한 이미지 파일인지 확인하는 메서드</em></p>\n<p><em><code class=\"language-text\">tryResizingAndSave</code>: “썸네일”이라는 의도에 맞게 적절한 크기로 resizing 후 저장하는 메서드</em></p>\n</blockquote>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271756046-33d7e7ee-f81d-4ac6-ac03-1356d8c1e81c.png\" alt=\"image\"></p>\n<p><code class=\"language-text\">checkInvalidImageFile</code>의 코드는 놀라울만큼 간단한데요,</p>\n<p>방금 위에서 봤던 <code class=\"language-text\">ImageIO.read</code>를 이용해서 이미지 여부만 판단하는게 전부입니다.</p>\n<blockquote>\n<p><em><code class=\"language-text\">ImageIO.read</code> 함수를 이용하면 이미지인지 확인이 가능하다. 이미지가 아니라면 <code class=\"language-text\">null</code>을 반환합니다.</em></p>\n</blockquote>\n<p>여기서 문제는 <code class=\"language-text\">file.getInputStream()</code> 코드인데, 여기서 <strong>이미 한 번 inputStream을 읽어버렸다는게 문제였습니다.</strong></p>\n<p>stream이라는 명칭에 걸맞게 한 번 읽은 stream은 <strong>재사용이 불가능합니다.</strong></p>\n<blockquote>\n<p>(mark, reset 기능이 있지만 제외하고…)</p>\n</blockquote>\n<p>그래서 이미 읽어버린 파일에 대해 다시 <code class=\"language-text\">getInputStream</code>을 가져오려니 문제가 생겼던 것입니다.</p>\n<p><strong>그럼 파일이 사라진건 무슨 일일까?</strong></p>\n<p>스프링의 <code class=\"language-text\">MultipartFile</code>은 임시 폴더에 데이터가 저장되는데요, 말 그대로 <strong>임시 폴더</strong>이기 때문에 스프링 내부적으로 MultipartFile의 <strong>데이터를 한 번 전부 읽고 나면 파일을 지워버립니다.</strong></p>\n<p>그래서 임시 파일이 없어졌고, 다시 읽어오려니 <code class=\"language-text\">NoSuchFileException</code>이 터진것이었습니다.</p>\n<h3>해결</h3>\n<p>해결은 간단하게 inputStream의 데이터를 처음 읽어올 때 <code class=\"language-text\">byte[]</code>로 저장해서 재사용하도록 했습니다.</p>\n<p>끝–</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n</style>","frontmatter":{"title":"MultipartFile read twice 문제 (with inputstream)","summary":"오늘은 MultipartFile에서 InputStream을 다루다가 생긴 문제에 대해서 공유해볼까 합니다.","date":"2023.08.13.","categories":["etc"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3ElEQVQoz12Ty6tPURTHzzkh8kh5R3mUgZT4B74rjwEjIzOKpJTvGihykeIyIHldj0xMLroDlL7rlpSUmYlHBsaiDEhSxIz2/q0fJ7tWZ5211/nstb5rn8bDGpe1FBrK0qrfMpD+P/PI3MB0D5uSsb/7NcEHkNmUzadsAYUZBewD4JzBXolhYX48jQIoLKUwN2NTKSwakrdQ+ErhI2WfKbynsMwDqyjcorCbwmUKxymMUhincITCdQpjFI5ROErhfDPyeGsBvqXwgcIEhfsUvlN4QKFUe4nCbQonKWyg8I6BXR52gMJzCisoPKNwhsLaJumfKJymcI7CtfR/UdhPYS+FCwzcozBCYSeF9RSMwkEPW0xhB4WbFN4U4CsKryncoPCFwjcKJyj8KK3VoUXVbGUOo9ogbg2HT2FTOaxJ+m8Kh7PlK6nXz1Kdh52lsISB1Yw6iHkMbGZgIwOnEtz2p1ycJx5WoJNVj6gHlLbXedgjCncZGGfgKgN3GLjIwAQDY3lDCrArNpzyGgpPKXtB2UsKDynM9LDlVYrAHg/bR+GQh20vlTGwrXTlslnD9uuqF1iWmvS0yQvr6r2Xano5/+/XNSjZWg/rfBJttbCuB2xTozb/qC5hXR/KrPAPFINmy3qE2ZIAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/8315cb308b890c7087edfc088043f572/22925/spring-boot-logo.png","srcSet":"/static/8315cb308b890c7087edfc088043f572/97024/spring-boot-logo.png 150w,\n/static/8315cb308b890c7087edfc088043f572/387ef/spring-boot-logo.png 300w,\n/static/8315cb308b890c7087edfc088043f572/22925/spring-boot-logo.png 600w","sizes":"(min-width: 600px) 600px, 100vw"},"sources":[{"srcSet":"/static/8315cb308b890c7087edfc088043f572/50262/spring-boot-logo.webp 150w,\n/static/8315cb308b890c7087edfc088043f572/2fedb/spring-boot-logo.webp 300w,\n/static/8315cb308b890c7087edfc088043f572/4fcbd/spring-boot-logo.webp 600w","type":"image/webp","sizes":"(min-width: 600px) 600px, 100vw"}]},"width":600,"height":315}},"publicURL":"/static/8315cb308b890c7087edfc088043f572/spring-boot-logo.png"}}}}]}},"pageContext":{"slug":"/etc/2023-08-13-MultipartFile read twice 문제 (with inputstream)/"}},"staticQueryHashes":["2518467932","429584967"]}