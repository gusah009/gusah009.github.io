{"componentChunkName":"component---src-templates-post-template-tsx","path":"/etc/2022-07-27-System_SetIn Junit Scanner/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>System.SetIn()과 Scanner를 이용한 Junit 다중 테스트 시 NoSuchElementException 발생하는 오류</p>\n</blockquote>\n<p><code class=\"language-text\">Scanner</code>를 이용한 테스트를 진행하던 중, <strong>단일 Junit 테스트에서는 문제 없이</strong> 성공하던게, <strong>전체 테스트를 돌리기만 하면</strong> 실패가 나오는 현상이 발생했습니다. 비슷한 문제를 겪고 있을 분들을 위해 문제의 원인과 해결 방법에 대해 말씀드리겠습니다.</p>\n<blockquote>\n<p><strong>테스트 환경</strong></p>\n<p><code class=\"language-text\">M1 mac</code>, <code class=\"language-text\">junit 5.8.1</code>, <code class=\"language-text\">assertj 3.11.1</code>, <code class=\"language-text\">IntelliJ</code></p>\n</blockquote>\n<h2>간단한 예제</h2>\n<p>아래에 <code class=\"language-text\">Scanner</code>를 이용한 간단한 예제를 만들어 보았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ScannerExample</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Scanner</span> <span class=\"token constant\">SCANNER</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Scanner</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">Integer</span> inputNum<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Status</span> <span class=\"token function\">input1or2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      inputNum <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SCANNER</span><span class=\"token punctuation\">.</span><span class=\"token function\">nextLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>inputNum <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> inputNum <span class=\"token operator\">!=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">SUCCESS</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">FAIL</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Status</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">SUCCESS</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">FAIL</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>위와 같이 코드를 작성한 뒤, 코드의 의도대로 1과 2만 받는 지 검증하는 테스트 코드를 작성했습니다.\n먼저 1만 넣었을 때 테스트 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">input1Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// given</span>\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">setIn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ScannerExample</span> ex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ScannerExample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// when</span>\n  <span class=\"token class-name\">Status</span> result <span class=\"token operator\">=</span> ex<span class=\"token punctuation\">.</span><span class=\"token function\">input1or2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// then</span>\n  <span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SUCCESS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만족스럽게 통과합니다. 다음으로 2의 경우를 테스트 해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">input2Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// given</span>\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">setIn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">ScannerExample</span> ex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ScannerExample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// when</span>\n  <span class=\"token class-name\">Status</span> result <span class=\"token operator\">=</span> ex<span class=\"token punctuation\">.</span><span class=\"token function\">input1or2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// then</span>\n  <span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SUCCESS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>역시 만족스럽게 통과합니다. 이제 두 개를 동시에 돌려보겠습니다.</p>\n<img width=\"974\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/181231712-0d36ee72-0739-4eb4-b08d-d1452652616b.png\">\n<p>놀랍게도 하나는 통과하고, 하나는 <code class=\"language-text\">NoSuchElement</code>를 발생시키며 실패합니다. 이는 테스트코드 순서에 따라 다른데, 사진에선 1이 2보다 먼저 실행됐지만, 2가 먼저 실행된다면 2는 성공하고 1은 실패하게 됩니다. 왜 이런 현상이 발생할까요?</p>\n<h3>Scanner와 테스트가 서로 다른 InputStream을 이용중이다</h3>\n<p>범인은 <code class=\"language-text\">System.SetIn()</code>안의 <code class=\"language-text\">new ByteArrayInputStream()</code>에 있습니다. 매 테스트마다 새로운 <code class=\"language-text\">InputStream</code>을 <code class=\"language-text\">System.in</code>에게 제공하고 있는데, 우리는 맨 처음 <code class=\"language-text\">ScannerExample</code>을 만들 때 <code class=\"language-text\">Scanner</code>를 <code class=\"language-text\">new Scanner(System.in)</code>으로 선언했습니다. 따라서 맨 처음 <code class=\"language-text\">InputStream</code>이 <code class=\"language-text\">Scanner</code>에는 계속 남아 있게 되는 것이고 두 번째 테스트부터는 <code class=\"language-text\">Scanner</code>가 다른 <code class=\"language-text\">InputStream</code>을 가지고 테스트를 진행하고 있는 꼴이 되는 것입니다.</p>\n<p>이에 대한 해결 방법으로 <code class=\"language-text\">Scanner</code>를 non-final 하게 풀고 매 테스트마다 초기화 해주는 방법이 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ScannerExample</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Scanner</span> <span class=\"token constant\">SCANNER</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Scanner</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">input1Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// given</span>\n  <span class=\"token class-name\">ByteArrayInputStream</span> inputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token constant\">SCANNER</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Scanner</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">setIn</span><span class=\"token punctuation\">(</span>inputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 되면, 매 테스트마다 <code class=\"language-text\">Scanner</code>가 서로 다른 <code class=\"language-text\">InputStream</code>을 가져서 충돌 없이 원활하게 다중 테스트를 실행시킬 수 있습니다.</p>\n<img width=\"785\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/181233460-a5ac4112-a7be-45c8-aba9-ecfc613f6b57.png\">\n<h2>inputStream을 수정할 순 없을까?</h2>\n<p>위 코드 예시에서 매 테스트마다 <code class=\"language-text\">InputStream</code>을 새로 생성하고 있는데, 제일 초기 <code class=\"language-text\">InputStream</code> 하나로 계속 코드를 작성하면 더 깔끔하고 <code class=\"language-text\">Scanner</code>도 <code class=\"language-text\">final</code>로 유지할 수 있을 것입니다. <strong>하지만 안타깝게도 <code class=\"language-text\">InputStream</code> 내부적으로 데이터를 넣는 메서드를 제공하고 있지 않습니다.</strong></p>\n<p>따라서 위 방식이 현재로선 최선으로 보입니다.</p>\n<p><strong>사용한 코드: <a href=\"https://github.com/gusah009/javaStudy/tree/master/blog/src/main/java/scanner_issue_220727\" target=\"_blank\" rel=\"nofollow\">https://github.com/gusah009/javaStudy/tree/master/blog/src/main/java/scanner_issue_220727</a></strong></p>\n<p><strong>사용한 테스트 코드: <a href=\"https://github.com/gusah009/javaStudy/tree/master/blog/src/test/java/scanner_issue_220727\" target=\"_blank\" rel=\"nofollow\">https://github.com/gusah009/javaStudy/tree/master/blog/src/test/java/scanner_issue_220727</a></strong></p>","frontmatter":{"title":"System.SetIn과 Scanner를 이용한 Junit 다중 테스트 시 NoSuchElementException","summary":"`Scanner`를 이용한 테스트를 진행하던 중, 단일 Junit 테스트에서는 문제 없이 성공하던게, 전체 테스트를 돌리기만 하면 실패가 나오는 현상이 발생했습니다. 비슷한 문제를 겪고 있을 분들을 위해 문제의 원인과 해결 방법에 대해 말씀드리겠습니다.","date":"2022.07.27.","categories":["etc"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAzUlEQVQY03XMTW6DMBRFYRbSHwiQ2oATjE1sbEISStMuoNPufxmnAqmVOujg03m6g5fk8xfN9RM/veP8gulvGBMYnafvPUOM3F/vLPPCOZwZTgPBBZx1dMcOq+0fyaHVXC8TH/Mb0XlOnaU7akxruMQJawwhBIZhYBxHYozbvfrZnXN47zdJ9pCS7wtqWXOoFKJ4IXtMN3IvaNsWay1a663GmM26932PUgohBFLKrcnuKaMoS1SjULKhSHPWLX/eIUtBVVX/Wp+srev61zeuSX3ninsj0QAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/89e48/Junit_test_success.png","srcSet":"/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/49817/Junit_test_success.png 393w,\n/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/f8531/Junit_test_success.png 785w,\n/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/89e48/Junit_test_success.png 1570w","sizes":"(min-width: 1570px) 1570px, 100vw"},"sources":[{"srcSet":"/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/c9fde/Junit_test_success.webp 393w,\n/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/229e6/Junit_test_success.webp 785w,\n/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/36108/Junit_test_success.webp 1570w","type":"image/webp","sizes":"(min-width: 1570px) 1570px, 100vw"}]},"width":1570,"height":298}},"publicURL":"/static/ab7ca101d91baee8ecb6b8bfc66e0aaf/Junit_test_success.png"}}}}]}},"pageContext":{"slug":"/etc/2022-07-27-System_SetIn Junit Scanner/"}},"staticQueryHashes":[]}