{"componentChunkName":"component---src-templates-post-template-tsx","path":"/etc/2024-03-20-Lettuce/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>Lettuce란?</h2>\n<p>Lettuce는 Java에서 사용하는 <strong>redis client 라이브러리</strong> 중 하나입니다.</p>\n<blockquote>\n<p>다른 대표적인 redis client 라이브러리로 Jedis가 있는데, 둘의 성능 차이는 아래 블로그에서 잘 비교해뒀습니다.</p>\n<p><a href=\"https://jojoldu.tistory.com/418\" target=\"_blank\" rel=\"nofollow\">https://jojoldu.tistory.com/418</a></p>\n</blockquote>\n<p>Lettuce는 <strong>netty와 reactor를 기반</strong>으로 하는 확장 가능한 스레드 안전 redis 클라이언트 입니다.</p>\n<p>Lettuce는 크게 <code class=\"language-text\">sync</code>, <code class=\"language-text\">async</code>, <code class=\"language-text\">reactive</code> 3가지 모드를 지원하는데 오늘 알아볼 모드는 <code class=\"language-text\">async</code> 입니다.</p>\n<h2>Lettuce async</h2>\n<p>Lettuce에서 제공하는 async API를 사용하면 <strong>기존 로직의 흐름을 방해하지 않고</strong> 레디스에 명령을 보낼 수 있습니다.</p>\n<blockquote>\n<p>⚠️ 주의. Lettuce async 커넥션은 redis에서 에러를 응답해도 exception을 던지지 않습니다!</p>\n<p>“Asynchronous connections do not throw exceptions when Redis responds with an error.”</p>\n</blockquote>\n<h3>사용법</h3>\n<p>사용법은 아래와 같이 RedisClient를 만들고 connection을 가져와서 명령어를 사용하기만 하면 됩니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">try</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">RedisClient</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redisClient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">RedisClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">create</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;redis://localhost:6379&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk10\">StatefulRedisConnection</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">String</span><span class=\"mtk1\">, </span><span class=\"mtk10\">String</span><span class=\"mtk1\">&gt; </span><span class=\"mtk12\">connect</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">redisClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connect</span><span class=\"mtk1\">.</span><span class=\"mtk11\">async</span><span class=\"mtk1\">().</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;test&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;yoyo&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connect</span><span class=\"mtk1\">.</span><span class=\"mtk11\">async</span><span class=\"mtk1\">().</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;test&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">whenComplete</span><span class=\"mtk1\">((result, exception) </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(result));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// yoyo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk7\">15000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>여기서 주의할 점은 <code class=\"language-text\">connect()</code> 메서드를 호출하면 <strong>항상 새로운 커넥션</strong>이 생긴다는 것입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; i &lt; </span><span class=\"mtk7\">10</span><span class=\"mtk1\">; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">StatefulRedisConnection</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">String</span><span class=\"mtk1\">, </span><span class=\"mtk10\">String</span><span class=\"mtk1\">&gt; </span><span class=\"mtk12\">connect</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">redisClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dec187e2d35b5556c0b1100451d3c29a/026af/lettuce-connection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABwElEQVQ4y2VTWZajMAzMIaaTgHfAxmB2ku5MPubN/S9V82SareejnmTZlqsk6zLOvzHML5B9vf9ier4xPt7opy98vv5EK42Fyjy8NdDG4MY0En7GnSkIXeBStxOqZkToZnTDZ7ShnVGFAU3/gA8DuMzBVAGbKyil8JFI3NIzrokAVzkuOivx68Zi4Jrwk/24L3ZlQczuXCMVyzoVZgMxjAnJWXHcPGKXJbcYsTrKpXVMSPWhxZJQbwmT9RG5PLJePO0d4ltCnXvcv19bGR6LbUoHrjKk3PzXiOP5TTLVaJegItZCU9x4G5mvZ444stsYZrbe6DOCJDZ6k58HHxmyyEbv4DqeZfJHU67U8lTGr0D1oi6SfyWkCqZySITBLdVLLFnOk71T19kejwlt5VF3DnVXop086r6MPiH0Hv0zoOocqtZt8RW+tfCNRTN4GEsqclyUsWBCImEcbTei7UekQoFLkiZivB/p00/gUkEoHUH+9PiKe+THO8QwkQrSOBSuQdM/4cOElAtIncH6HtZ3yGwAk/ku+RtCO3Btz5JN7aALDxrB0E4oyhbOKpRlgaqZ0Q7POKM0NT8//DJV4vQP/wFtIGVD6mIc7QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/dec187e2d35b5556c0b1100451d3c29a/a59e9/lettuce-connection.webp 192w,\n/static/dec187e2d35b5556c0b1100451d3c29a/0ca9f/lettuce-connection.webp 384w,\n/static/dec187e2d35b5556c0b1100451d3c29a/dc9b9/lettuce-connection.webp 768w,\n/static/dec187e2d35b5556c0b1100451d3c29a/73426/lettuce-connection.webp 830w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/dec187e2d35b5556c0b1100451d3c29a/3b721/lettuce-connection.png 192w,\n/static/dec187e2d35b5556c0b1100451d3c29a/66595/lettuce-connection.png 384w,\n/static/dec187e2d35b5556c0b1100451d3c29a/fe486/lettuce-connection.png 768w,\n/static/dec187e2d35b5556c0b1100451d3c29a/026af/lettuce-connection.png 830w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/dec187e2d35b5556c0b1100451d3c29a/fe486/lettuce-connection.png\"\n            alt=\"image\"\n            title=\"image\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>redis는 단일 스레드라 <strong>커넥션이 많아진다고 해서 명령이 빨리 수행되는게 아니기 때문에</strong> 커넥션은 하나만 만들어두고 사용하는게 좋습니다.</p>\n<h3>aysnc에 사용되는 스레드</h3>\n<p>비동기로 redis 명령어를 보내려면 어딘가에선 명령을 수행해주어야 합니다.</p>\n<p>이를 위해 Lettuce는 계산 작업에 <code class=\"language-text\">Runtime.getRuntime().availableProcessors() * 3</code>의 스레드를 default로 등록해둡니다.</p>\n<p>그리고 모든 I/O 연산에도 <code class=\"language-text\">Runtime.getRuntime().availableProcessors() * 3</code>의 스레드를 default로 등록해둡니다.</p>\n<blockquote>\n<p>이건 추측인데, redis에 요청을 보내고 받는 네트워크 작업은 I/O 스레드가, 그 외에 모든 연산은 계산 스레드가 하는 것 같습니다.</p>\n</blockquote>\n<h2>주의 해야 할 점</h2>\n<h3>eventloop blocking</h3>\n<p>Lettuce의 future는 netty의 EventLoop에서 수행이 됩니다.</p>\n<p>eventLoop를 blocking 하는 건 좋지 않은 선택이기 때문에 혹여나 redis에서 응답을 받아서 장기 처리를 할 일이 있다면 <code class=\"language-text\">thenAccept()</code> 보단 <code class=\"language-text\">thenAcceptAsync()</code>를 활용해 또 다른 스레드로 빼는게 좋습니다.</p>\n<p>아래는 좋지 않은 예시입니다.</p>\n<p>이벤트 루프를 블락해 다른 명령어들까지 동작을 지연시키고 있습니다. 아래 로직은 <strong>100초가 지나야 끝납니다.</strong></p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; i &lt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalI</span><span class=\"mtk1\"> = i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connect</span><span class=\"mtk1\">.</span><span class=\"mtk11\">async</span><span class=\"mtk1\">().</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;test&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">thenAccept</span><span class=\"mtk1\">((result) </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currentThread</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getName</span><span class=\"mtk1\">() + </span><span class=\"mtk8\">&quot; done! &quot;</span><span class=\"mtk1\"> + finalI);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">InterruptedException</span><span class=\"mtk1\"> </span><span class=\"mtk12\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RuntimeException</span><span class=\"mtk1\">(e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lettuce-nioEventLoop-4-1 done! 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lettuce-nioEventLoop-4-1 done! 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lettuce-nioEventLoop-4-1 done! 2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lettuce-nioEventLoop-4-1 done! 3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// lettuce-nioEventLoop-4-1 done! 4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// ...</span></span></span></code></pre>\n<p>좋은 예시입니다. 이벤트 루프를 블락하지 않고 별도의 스레드로 이후 로직을 진행하기 때문에 이벤트 루프는 방해받지 않습니다.</p>\n<p>아래 로직은 대략 <strong>1초후에 종료됩니다.</strong></p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">ExecutorService</span><span class=\"mtk1\"> </span><span class=\"mtk12\">executorService</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Executors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">newFixedThreadPool</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; i &lt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connect</span><span class=\"mtk1\">.</span><span class=\"mtk11\">async</span><span class=\"mtk1\">().</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;test&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">thenAcceptAsync</span><span class=\"mtk1\">((result) </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currentThread</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getName</span><span class=\"mtk1\">() + </span><span class=\"mtk8\">&quot; done!&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">InterruptedException</span><span class=\"mtk1\"> </span><span class=\"mtk12\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RuntimeException</span><span class=\"mtk1\">(e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }, executorService);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<blockquote>\n<p><code class=\"language-text\">...async()</code> 메서드의 경우 스레드를 지정해주지 않으면 default 스레드로 <code class=\"language-text\">ForkJoinPool.commonPool()</code>을 사용합니다.</p>\n</blockquote>\n<h2>options</h2>\n<p>몇 가지 유용한 옵션도 알아보려 합니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">RedisClient</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getRedisClient</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">RedisClient</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redisClient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">RedisClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">create</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;redis://localhost:6379&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">redisClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ClientOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">builder</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">requestQueueSize</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// 이벤트 루프가 바쁠 때 queue에 넣고 대기합니다. 만약 queue가 가득 찼다면 exception을 던지고 요청을 무시합니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">timeoutOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TimeoutOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">enabled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Duration</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ofNanos</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">))) </span><span class=\"mtk3\">// command의 timeout 값을 설정합니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">build</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> redisClient;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3>requestQueueSize</h3>\n<p>eventloop에 들어가기 전 큐에 요청을 쌓아둘 수 있는데요, <strong>그럼 eventloop가 바쁘더라도</strong> 일단 queue에 넣기 때문에 <strong>전체 로직에 영향은 줄일 수 있습니다.</strong></p>\n<p>아래는 앞서 봤던 eventloop를 블락킹하는 코드입니다. 하지만 <code class=\"language-text\">requestQueueSize</code>를 <strong>100</strong>으로 설정해뒀기 때문에 메인 로직은 막히는 것 없이 바로 완료되는 모습입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; i &lt; </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalI</span><span class=\"mtk1\"> = i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connect</span><span class=\"mtk1\">.</span><span class=\"mtk11\">async</span><span class=\"mtk1\">().</span><span class=\"mtk11\">set</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;test&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;async&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">whenComplete</span><span class=\"mtk1\">((result, exception) </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;done! = &quot;</span><span class=\"mtk1\"> + finalI);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;exception = &quot;</span><span class=\"mtk1\"> + exception);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk7\">500</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">InterruptedException</span><span class=\"mtk1\"> </span><span class=\"mtk12\">e</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RuntimeException</span><span class=\"mtk1\">(e);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">System</span><span class=\"mtk1\">.</span><span class=\"mtk12\">out</span><span class=\"mtk1\">.</span><span class=\"mtk11\">println</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;queue insert done!!&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">queue insert done!!</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">done! = 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">exception = null</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">done! = 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">exception = null</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">done! = 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">exception = null</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">done! = 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">exception = null</span></span></code></pre>\n<p>만약 큐가 가득 찼다면 아래와 같은 exception을 던지면서 command를 무시해버립니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">io.lettuce.core.RedisException: Request queue size exceeded: 100. Commands are not accepted until the queue size drops.</span></span></code></pre>\n<h3>timeoutOptions</h3>\n<p>command의 timeout 값을 설정할 수 있습니다. 여기서 주의해야 할 점은, <strong>sync, async 구분 없이 모두 timeout 설정이 된다는 점입니다.</strong></p>\n<p>다만 async의 경우 exception을 외부까지 가져오지 않기 때문에 <strong>exception을 무시</strong>해버립니다.</p>\n<p>때문에 에러 로깅을 하고 싶다면 앞서 봤던 <code class=\"language-text\">.whenCompleteAsync()</code> 같은 메서드를 사용해 exception을 잡아야 합니다.</p>\n<h2>참고</h2>\n<p><a href=\"https://lettuce.io/core/release/reference/index.html\" target=\"_blank\" rel=\"nofollow\">https://lettuce.io/core/release/reference/index.html</a></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Lettuce async","summary":"lettuce 사용중에 배운 내용들을 공유드리겠습니다.","date":"2024.03.20.","categories":["etc"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQUlEQVQoz51QuU7DQBD1f9HyH/Sh4gcoKCjzB0hIfAASEgUVRVIghKIkUiAXsY1Z7+Hsro/E584axU7IIaRIvGbfaPbNzHtGuYbePFtS84octmpirGut0yLOVbI76CiM+mvLvG+2z2/eLt1wxmNSQJ4WSxHTKe9NeTdVMWgVpkImbJkFUeZvN2utr5/PLh5PGw8nT+O7IJ1HmZzw7jt9+WCvU97zFt9fcjSZd2XC+qT1KfpZdaOhK0c93Gq2G7edqyDhOLRsf2iKgRvMHH80EwPbH469ji2HJLJNOWALp7Zt/BoArcp1QqDKHLSqogIoVa7SqlxxBYWCYj+wUiulLMuilDqOI7iglJmmhRAihAohEUIYY0Y9ALUb2GYzgOd5GGPXRZzPoyhaKSlhjIVhQCghhAghAOAP8T+wJ9bHcCD+AVrNOU4CBQhnAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/2fc845d57a6242981879ff81819e9cde/baae3/lettuce-logo.png","srcSet":"/static/2fc845d57a6242981879ff81819e9cde/7feaf/lettuce-logo.png 320w,\n/static/2fc845d57a6242981879ff81819e9cde/c9c25/lettuce-logo.png 640w,\n/static/2fc845d57a6242981879ff81819e9cde/baae3/lettuce-logo.png 1280w","sizes":"(min-width: 1280px) 1280px, 100vw"},"sources":[{"srcSet":"/static/2fc845d57a6242981879ff81819e9cde/83dfe/lettuce-logo.webp 320w,\n/static/2fc845d57a6242981879ff81819e9cde/83510/lettuce-logo.webp 640w,\n/static/2fc845d57a6242981879ff81819e9cde/9d163/lettuce-logo.webp 1280w","type":"image/webp","sizes":"(min-width: 1280px) 1280px, 100vw"}]},"width":1280,"height":640}},"publicURL":"/static/2fc845d57a6242981879ff81819e9cde/lettuce-logo.png"}}}}]}},"pageContext":{"slug":"/etc/2024-03-20-Lettuce/"}},"staticQueryHashes":["2518467932","429584967"]}