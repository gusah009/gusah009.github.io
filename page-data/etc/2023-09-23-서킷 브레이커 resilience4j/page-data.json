{"componentChunkName":"component---src-templates-post-template-tsx","path":"/etc/2023-09-23-서킷 브레이커 resilience4j/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><strong>오늘은 자바 서킷브레이커 라이브러리 resilience4j를 사용해 본 내용을 공유해보겠습니다.</strong></p>\n<h2>서킷 브레이커?</h2>\n<p>서킷 브레이커는 다른 서비스에 대한 호출을 모니터링 하다가 요청의 실패율이 일정 임계치를 넘어가면, 장애가 발생한 서비스로의 요청을 차단해 <strong>빠르게 실패처리</strong>를 하는 방법입니다.</p>\n<blockquote>\n<p><em>참고: <a href=\"https://hudi.blog/circuit-breaker-pattern/\" target=\"_blank\" rel=\"nofollow\">https://hudi.blog/circuit-breaker-pattern</a></em></p>\n</blockquote>\n<p>timeout이 날 때 까지 기다리지 않고 빠르게 실패처리를 하는 이유는, 스레드 기반 웹 서버에서 한 요청이 한 스레드를 너무 오래 점유하기 때문인데요.</p>\n<p>이를 감지해서 문제가 있는 API는 빠르게 실패 처리를 함으로써 다른 멀쩡한 요청들을 더 수월하게 받아들이기 위함입니다.</p>\n<h2><strong>Resilience4j CircuitBreaker</strong></h2>\n<p>경량화 서킷 브레이커중 자바 라이브러리인 <code class=\"language-text\">Resilience4j</code>를 사용해보겠습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819498-1b66a17a-5937-4650-8456-aaf8a243f8fe.png\" alt=\"image\"></p>\n<p>컨셉은 아주 간단한데요, 평상시 상태는 <code class=\"language-text\">Closed</code>이고 문제가 생기면 <code class=\"language-text\">Open</code>으로 바뀌며 (<em>“이 때를 서킷이 열렸다”</em> 고 표현합니다) 이후 일정 기간동안 오는 모든 요청을 실패처리합니다.</p>\n<p>그리고 일정 기간 후엔 <code class=\"language-text\">Half Open</code>으로 바뀌며 여전히 외부 서버에 문제가 있는지 확인하고, 문제가 있으면 다시 <code class=\"language-text\">Open</code>, 없으면 <code class=\"language-text\">Closed</code>로 바뀝니다.</p>\n<h3>Implementation</h3>\n<p>제 프로젝트에선 <code class=\"language-text\">spring-boot3</code>를 사용하고 있어서 아래처럼 의존성을 추가해줍니다.</p>\n<blockquote>\n<p>참고로 뒤에서 사용할 <code class=\"language-text\">@CircuitBreaker</code> 어노테이션은 내부적으로 AOP를 사용하기 때문에 aop 관련 의존성도 추가해주어야 합니다.</p>\n</blockquote>\n<pre class=\"grvsc-container default-dark\" data-language=\"groovy\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">implementation </span><span class=\"mtk8\">&#39;io.github.resilience4j:resilience4j-spring-boot3:2.1.0&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">implementation </span><span class=\"mtk8\">&#39;org.springframework.boot:spring-boot-starter-aop&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">implementation </span><span class=\"mtk8\">&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// 선택!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">implementation </span><span class=\"mtk8\">&#39;io.micrometer:micrometer-registry-prometheus&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// 선택!</span></span></span></code></pre>\n<p>먼저, <code class=\"language-text\">application.yaml</code> 파일에 아래와 같이 설정해줍니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"yaml\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">resilience4j</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">circuitbreaker</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">configs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">sliding-window-type</span><span class=\"mtk1\">: </span><span class=\"mtk8\">COUNT_BASED</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># window는 개수 base로 설정. 이외에 TIME_BASED도 있음</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">sliding-window-size</span><span class=\"mtk1\">: </span><span class=\"mtk7\">100</span><span class=\"mtk1\">         </span><span class=\"mtk3\"># 100개의 요청 중에,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">waitDurationInOpenState</span><span class=\"mtk1\">: </span><span class=\"mtk8\">3s</span><span class=\"mtk1\">      </span><span class=\"mtk3\"># OPEN 상태에서 3초간 기다림. HALF_OPEN 상태로 빨리 전환되어 장애가 복구 될 수 있도록 기본값(60s)보다 작게 설정</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">failureRateThreshold</span><span class=\"mtk1\">: </span><span class=\"mtk7\">30</span><span class=\"mtk1\">         </span><span class=\"mtk3\"># 실패가 30퍼센트 이상이면 서킷이 열린다. 기본값(50%)보다 조금 작게 설정</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">permittedNumberOfCallsInHalfOpenState</span><span class=\"mtk1\">: </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># HALF_OPEN 상태에서 10개의 요청을 허용</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">slowCallRateThreshold</span><span class=\"mtk1\">: </span><span class=\"mtk7\">80</span><span class=\"mtk1\">        </span><span class=\"mtk3\"># 80퍼센트 이상 slowCall이 발생하면 서킷이 열린다. 기본값(100%)보다 조금 작게 설정</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">slowCallDurationThreshold</span><span class=\"mtk1\">: </span><span class=\"mtk8\">500ms</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># API를 가져오는데 500ms 이상 걸리면 slowCall로 판단함. 해당 값은 TimeLimiter의 timeoutDuration보다 작아야 함</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">registerHealthIndicator</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">    </span><span class=\"mtk3\"># actuator를 이용해 health를 확인할 지 여부</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">recordFailurePredicate</span><span class=\"mtk1\">: </span><span class=\"mtk8\">com.example.playground.resilience4j.RestTemplateCircuitRecordFailurePredicate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">instances</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">gusah009</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">baseConfig</span><span class=\"mtk1\">: </span><span class=\"mtk8\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">baseConfig</span><span class=\"mtk1\">: </span><span class=\"mtk8\">default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">timelimiter</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">configs</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">call</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">timeoutDuration</span><span class=\"mtk1\">: </span><span class=\"mtk8\">1000ms</span><span class=\"mtk1\"> </span><span class=\"mtk3\"># slowCallDurationThreshold보다는 크게 설정되어야 함</span></span></span></code></pre>\n<blockquote>\n<p>각각의 config에 대해선 guide에 매우 상세하게 잘 나와있습니다.</p>\n<p>guide: <a href=\"https://resilience4j.readme.io/docs/circuitbreaker\" target=\"_blank\" rel=\"nofollow\">https://resilience4j.readme.io/docs/circuitbreaker</a></p>\n</blockquote>\n<p>이번 테스트에 사용된 코드입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Slf4j</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RestController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RequiredArgsConstructor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">GetExchangeRateTemplate</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ResilienceService</span><span class=\"mtk1\"> </span><span class=\"mtk12\">resilienceService</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">CircuitBreakerRegistry</span><span class=\"mtk1\"> </span><span class=\"mtk12\">circuitBreakerRegistry</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk10\">GetMapping</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;/many-calls&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ResponseEntity</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">State</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">manyCalls</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            @</span><span class=\"mtk10\">RequestParam</span><span class=\"mtk1\">(defaultValue = </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ok</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            @</span><span class=\"mtk10\">RequestParam</span><span class=\"mtk1\">(defaultValue = </span><span class=\"mtk8\">&quot;0&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">error</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">callMany</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ok&quot;</span><span class=\"mtk1\">, ok);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">callMany</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;error&quot;</span><span class=\"mtk1\">, error);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ResponseEntity</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ok</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                circuitBreakerRegistry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        .</span><span class=\"mtk11\">circuitBreaker</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;gusah009&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        .</span><span class=\"mtk11\">getState</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">callMany</span><span class=\"mtk1\">(</span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">, </span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; i &lt; count; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">resilienceService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(param);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">Exception</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ignore</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk10\">GetMapping</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ok&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ResponseEntity</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">String</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">ok</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ResponseEntity</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ok</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ok~!&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk10\">GetMapping</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;error&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ResponseEntity</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">String</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">error</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ResponseEntity</span><span class=\"mtk1\">.</span><span class=\"mtk11\">internalServerError</span><span class=\"mtk1\">().</span><span class=\"mtk11\">body</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;error~!&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Service</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RequiredArgsConstructor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ResilienceService</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">RestTemplate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">restTemplate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk10\">CircuitBreaker</span><span class=\"mtk1\">(name = </span><span class=\"mtk8\">&quot;gusah009&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">param</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">restTemplate</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getForEntity</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;http://localhost:8080/&quot;</span><span class=\"mtk1\"> + param, </span><span class=\"mtk12\">String</span><span class=\"mtk1\">.</span><span class=\"mtk12\">class</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getBody</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// true 를 리턴하면 Fail 로 기록됨.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">RestTemplateCircuitRecordFailurePredicate</span><span class=\"mtk1\"> </span><span class=\"mtk4\">implements</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Predicate</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Throwable</span><span class=\"mtk1\">&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk10\">Override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">boolean</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test</span><span class=\"mtk1\">(</span><span class=\"mtk10\">Throwable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">throwable</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 4XX 클라이언트 에러는 fail로 기록하지 않음</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (throwable </span><span class=\"mtk4\">instanceof</span><span class=\"mtk1\"> HttpClientErrorException) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 그 외에 에러는 모두 failure로 기록함(HttpServerErrorException, connection, timeout, IOException 등)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code class=\"language-text\">http://localhost:8080/many-calls?ok=100</code></p>\n<p>위 url을 이용해서 100회 호출 모두 ok가 떨어지도록 계속 호출해보겠습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819513-7bbb4b5d-44b7-4218-bf57-74527c721259.png\" alt=\"image\"></p>\n<p>grafana에서 successful이 잘 증가하는 것을 볼 수 있습니다.</p>\n<p>그럼 실패 10, 성공 90으로 다시 호출해보겠습니다.</p>\n<p><code class=\"language-text\">http://localhost:8080/many-calls?ok=90&amp;error=10</code></p>\n<p>기가 막히게 10% 실패율이 뜨는 것을 볼 수 있습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819608-049936a4-ad34-4eb8-a5cf-10f0c56e1261.png\" alt=\"image\"></p>\n<p><code class=\"language-text\">http://localhost:8080/many-calls?ok=71&amp;error=error=10)29</code></p>\n<p>하지만 아직 실패 임계치(30%)엔 미치지 못했네요. 29%까지 늘려봅시다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819595-a7839811-5653-4ec0-84b8-28851c4cafd8.png\" alt=\"image\"></p>\n<p>실패율은 29%를 찍었지만 서킷은 여전히 닫혀(closed)있는 것을 볼 수 있습니다.</p>\n<p>이제 서킷을 열어봅시다. 실패율을 30%로 맞춰보겠습니다.</p>\n<p><code class=\"language-text\">http://localhost:8080/many-calls?ok=70&amp;error=error=10)30</code></p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819620-015e247e-00f8-42ad-8d1e-f637a64295a7.png\" alt=\"image\"></p>\n<p>서킷이 열렸군요!</p>\n<p>이제 오픈 상태에선 <code class=\"language-text\">waitDurationInOpenState</code>(3초)동안 아무리 호출을 해도 실패가 떨어질 것입니다.</p>\n<p>3초 후에 HALF_OPEN 상태에선 <code class=\"language-text\">permittedNumberOfCallsInHalfOpenState</code> 를 따르는데요, 여기서 10개의 호출을 시범삼아 보내보고, 앞서 설정했던 <code class=\"language-text\">failureRateThreshold</code> 퍼센트를 또 확인합니다.</p>\n<p>여기서 만약 실패율이 30%이상이면 다시 OPEN 상태로 변하고, 30% 미만이면 CLOSED 상태로 변합니다.</p>\n<p>서킷이 다시 열리도록 한 번 <strong>성공7실패3</strong> 으로 호출해보겠습니다.</p>\n<p><code class=\"language-text\">http://localhost:8080/many-calls?ok=7&amp;error=3</code></p>\n<p>여전히 위 그래프와 똑같이 서킷이 열려있는걸 확인할 수 있습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819624-961cf440-008e-42f8-aaf7-886c0dbe9813.png\" alt=\"image\"></p>\n<p>한 번 서킷을 닫아봅시다. <strong>성공8실패2</strong> 로 호출해보겠습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271819627-5dfd72a3-ea0e-4fd5-83e3-f00e657e7fc9.png\" alt=\"image\"></p>\n<p>실패율은 20%로 변하고 서킷이 다시 닫히는걸 볼 수 있습니다. 이제 호출이 다시 정상적으로 이루어집니다.</p>\n<p>여기까지 간단하게 자바 서킷 브레이커 라이브러리인 <code class=\"language-text\">resilience4j</code>를 사용해봤습니다.</p>\n<p>기회가 된다면 Slow call을 실패로 처리하는 <code class=\"language-text\">@TimeLimiter</code>도 포스팅해보겠습니다.</p>\n<p>감사합니다.</p>\n<p>참고: <a href=\"https://mangkyu.tistory.com/290\" target=\"_blank\" rel=\"nofollow\">https://mangkyu.tistory.com/290</a></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"서킷 브레이커 resilience4j","summary":"오늘은 자바 서킷브레이커 라이브러리 resilience4j를 사용해 본 내용을 공유해보겠습니다.","date":"2023.09.23.","categories":["etc"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC1UlEQVQ4y21TO0jrYBT+FcHFwW4idHVQwSqJNa3toBQqBSFLEEERDNRFBUEKVhC0i0gncSh0EC2FCgodAuIbstS5Ig1UlE7ig6oIbZL+OZd6en+j935DSM7Jd57fIfATlmVRSgHg+vpaluWVlZXHx0cAQOMvEPsHpdQ0TQC4vb11OBzkCyMjI+g1TdOyrP+TMXa1WgWAra0tQkhbW1tLS0tra+vNzY31BUqpnd8g12o1ACiVSqOjo5FI5OrqihDS3NxMCOnq6tI0ze12b25uYl+MTxgzl8t1dnZGo9FKpYLJnU5nX1/f5eUlAOTzeY7jRFFEJj4JVnt3d9fR0ZHJZLB+9FWrVYzLUgWDwampKdYjQcfY2FgsFgMAXdfRwmj4gk9d1/v7+w8PD9FSL/vs7EwQhF/94HjsE8JFZLNZr9f73bMsyziMWq2GqTAPA1owimEYQ0NDuVyuQR4eHlZVlZGRUKlUHh4eSqWSrutsl4ZhAMDk5OTOzk6d/PHxMTAwkM/nmXt/fz8UCvE87/8Cz/OiKGazWSahpaWl5eXlOvnz83N8fPz+/h4AXl5eBEHw+/2pVKpYLJbL5dfX10KhkEgkOI4LBALlchkAYrHYxsZGo2xN0yKRyNramqZp5+fnGN6udlzb0dHR09OToih7e3tvb2+Nst1udzgcnp2d9Xg8qBDDMHDOOHPTNHGxoigODg7yPD8zM1Mn7+7uer1eFL0gCMlkkm3FPm0ASKfTPp8Pa+nt7b24uCCKohBCHA5He3t7U1PTyckJ+5sBYx0cHHg8HpxrT09PXf+U0omJCby+hYUFpio72DFLksTzvMvlkmX5+zBUVS0UCqqqSpJULBbtekYkk8n5+XlKqaIop6enjcOw/gIA3t/fo9Fod3d3MBhcXV3d3t6Ox+Nzc3Mcx/l8vuPjYxa0cRj/CvD5+TmVSi0uLkqSND09vb6+rqqq/U7YRP4A8SuqmzyMaKEAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/2a3b74caf57a5dfa622fe94f4d0b4281/6b9ce/resilience4j.png","srcSet":"/static/2a3b74caf57a5dfa622fe94f4d0b4281/24271/resilience4j.png 56w,\n/static/2a3b74caf57a5dfa622fe94f4d0b4281/43fd1/resilience4j.png 112w,\n/static/2a3b74caf57a5dfa622fe94f4d0b4281/6b9ce/resilience4j.png 224w","sizes":"(min-width: 224px) 224px, 100vw"},"sources":[{"srcSet":"/static/2a3b74caf57a5dfa622fe94f4d0b4281/d66a6/resilience4j.webp 56w,\n/static/2a3b74caf57a5dfa622fe94f4d0b4281/9d3b6/resilience4j.webp 112w,\n/static/2a3b74caf57a5dfa622fe94f4d0b4281/e7b7a/resilience4j.webp 224w","type":"image/webp","sizes":"(min-width: 224px) 224px, 100vw"}]},"width":224,"height":224}},"publicURL":"/static/2a3b74caf57a5dfa622fe94f4d0b4281/resilience4j.png"}}}}]}},"pageContext":{"slug":"/etc/2023-09-23-서킷 브레이커 resilience4j/"}},"staticQueryHashes":["2518467932","429584967"]}