{"componentChunkName":"component---src-templates-post-template-tsx","path":"/keeper-homepage/2022-09-08-스케줄러와 Transaction 그리고 테스트 코드에서 생긴 문제 해결하기/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>스케줄러와 Transaction 그리고 테스트 코드에서 생긴 문제 해결하기</p>\n</blockquote>\n<p>안녕하세요. 오늘은 스케줄러를 이용하면서 생긴 <code class=\"language-text\">LazyInitializationException</code>문제와 테스트 코드에서의 문제에 대해 작성해 보겠습니다.</p>\n<p>해당 문제를 재현하기 위해 <strong>간단한 예시 프로젝트</strong>를 생성하였습니다.</p>\n<blockquote>\n<p>사용한 기술 스택 버전 정보</p>\n<p>gradle <code class=\"language-text\">7.5</code></p>\n<p>springboot <code class=\"language-text\">2.7.3</code></p>\n<p>JDK <code class=\"language-text\">17</code></p>\n<p>MySQL <code class=\"language-text\">8.0.29</code></p>\n</blockquote>\n<p>전체 코드는 해당 링크에서 확인할 수 있습니다. <a href=\"https://github.com/gusah009/javaStudy/tree/master/webBlog\" target=\"_blank\" rel=\"nofollow\">https://github.com/gusah009/javaStudy/tree/master/webBlog</a></p>\n<p>전체 디렉토리 구조는 다음과 같습니다.</p>\n<img width=\"396\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189026938-e05d5463-fe3f-4518-b77f-c150a496f724.png\">\n<p>간단하게 프로젝트 설명을 하자면, 시간(seconds)과 함께 요청을 보낼 경우 <strong>해당 시간에 모든 회원의 팀이 <code class=\"language-text\">\"정현모 팀\"</code>으로 바뀝니다.</strong></p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RestController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RequiredArgsConstructor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberController</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberService</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memberService</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">PostMapping</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;/reserve&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      @</span><span class=\"mtk10\">RequestBody</span><span class=\"mtk1\"> @</span><span class=\"mtk10\">NotNull</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Integer</span><span class=\"mtk1\"> </span><span class=\"mtk12\">seconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memberService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(seconds);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>간단한 <code class=\"language-text\">MemberController</code>입니다. <code class=\"language-text\">seconds</code>와 함께 요청을 보내면 해당 <code class=\"language-text\">seconds</code>후에 모든 회원의 팀이 변경됩니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Service</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RequiredArgsConstructor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Transactional</span><span class=\"mtk1\">(readOnly = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberService</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">static</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ZoneOffset</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SEOUL_ZONE_OFFSET</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ZoneOffset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">of</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;+09:00&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">SchedulerService</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schedulerService</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberRepository</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memberRepository</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TeamRepository</span><span class=\"mtk1\"> </span><span class=\"mtk12\">teamRepository</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Transactional</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">seconds</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Date</span><span class=\"mtk1\"> </span><span class=\"mtk12\">taskDate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getDatePlusSeconds</span><span class=\"mtk1\">(seconds);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Runnable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">task</span><span class=\"mtk1\"> = () </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeDefaultTeamMembersTeamTo</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;정현모&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">schedulerService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">scheduleTask</span><span class=\"mtk1\">(task, taskDate);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;SUCCESS&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Date</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDatePlusSeconds</span><span class=\"mtk1\">(</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">seconds</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk11\">now</span><span class=\"mtk1\">().</span><span class=\"mtk11\">plusSeconds</span><span class=\"mtk1\">(seconds).</span><span class=\"mtk11\">toInstant</span><span class=\"mtk1\">(SEOUL_ZONE_OFFSET));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeDefaultTeamMembersTeamTo</span><span class=\"mtk1\">(</span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">teamName</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">List</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Member</span><span class=\"mtk1\">&gt; </span><span class=\"mtk12\">allMembers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">memberRepository</span><span class=\"mtk1\">.</span><span class=\"mtk11\">findAll</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Team</span><span class=\"mtk1\"> </span><span class=\"mtk12\">myTeam</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getTeamByName</span><span class=\"mtk1\">(teamName);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">Member</span><span class=\"mtk1\"> </span><span class=\"mtk12\">member</span><span class=\"mtk1\"> </span><span class=\"mtk15\">:</span><span class=\"mtk1\"> allMembers) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// 조금 억지스럽지만, 추후에 있을 LazyInitializationException을 보여주기 위해 이름으로 비교</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">Objects</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">member</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTeam</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getName</span><span class=\"mtk1\">(), DEFAULT_NAME)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">member</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeTeam</span><span class=\"mtk1\">(myTeam);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">memberRepository</span><span class=\"mtk1\">.</span><span class=\"mtk11\">saveAll</span><span class=\"mtk1\">(allMembers);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Team</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTeamByName</span><span class=\"mtk1\">(</span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">teamName</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">teamRepository</span><span class=\"mtk1\">.</span><span class=\"mtk11\">findByName</span><span class=\"mtk1\">(teamName)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">orElseThrow</span><span class=\"mtk1\">(RuntimeException</span><span class=\"mtk15\">::new</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>다음으로 서비스 코드입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">SchedulerConfig</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Bean</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TaskScheduler</span><span class=\"mtk1\"> </span><span class=\"mtk11\">taskScheduler</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">ScheduledExecutorService</span><span class=\"mtk1\"> </span><span class=\"mtk12\">scheduledExecutorService</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Executors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">newSingleThreadScheduledExecutor</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ConcurrentTaskScheduler</span><span class=\"mtk1\">(scheduledExecutorService);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>마지막으로 <code class=\"language-text\">SchedulerConfig</code>입니다. 크게 어려운 내용 없이 <code class=\"language-text\">Spring</code>의 <code class=\"language-text\">TaskScheduler</code>를 <code class=\"language-text\">Bean</code>으로 주입해주고 있는 모습입니다.</p>\n<h2><code class=\"language-text\">LazyInitializationException</code> 발생</h2>\n<p>아주 간단한 로직이고 문제가 없어보이지만 실행시킬 경우 아래와 같은 에러가 발생합니다.</p>\n<img width=\"1678\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189481790-ed6cf68c-f905-4e53-928b-200758cc0311.png\">\n<p>문제가 발생한 원인은 간단합니다.</p>\n<p><code class=\"language-text\">Lazy Loading</code>을 위해선 하나의 트랜잭션에서 영속성 컨텍스트 관리가 되어야 하는데, <code class=\"language-text\">task</code>로 수행시킨 <code class=\"language-text\">changeDefaultTeamMembersTeamTo()</code>메서드에선 <strong>트랜잭션이 존재하지 않기 때문에</strong> 발생한 에러였습니다.</p>\n<p>이런 의구심이 들 수 있습니다. <strong><code class=\"language-text\">reserveMemberTeamChange()</code> 메서드에 분명 <code class=\"language-text\">@Transactional</code>을 선언해 줬는데, 왜 트랜잭션이 생기지 않은거지?</strong></p>\n<p>정답은 바로 스프링의 <code class=\"language-text\">TaskScheduler</code>에 있습니다. 스프링의 <code class=\"language-text\">TaskScheduler</code>는 <strong>내부적으로 새로운 스레드를 만들어서 동작하기 때문에 상위 메서드에서 선언한 트랜잭션과 무관합니다.</strong></p>\n<p>해결하기 위한 방법으로 <strong>스케줄러 스레드</strong>에 트랜잭션을 걸어주는 방법을 선택했습니다. 하지만 선언적 트랜잭션 (<code class=\"language-text\">@Transactional</code> 어노테이션)은 사용할 수 없었습니다.</p>\n<p>이유는 바로 <code class=\"language-text\">private changeDefaultTeamMembersTeamTo()</code> 메서드가 <code class=\"language-text\">private</code>이기 때문입니다. <code class=\"language-text\">@Transactional</code> 어노테이션은 <code class=\"language-text\">public</code> 메서드만 지원하기 때문에 해당 방법은 쓸 수 없었습니다.</p>\n<blockquote>\n<p>접근자를 <code class=\"language-text\">public</code>으로 바꾸고 사용해도 되지만, 실제 프로젝트에서 해당 메서드는 다른 서비스에서 사용하지 않길 원했기 때문에 <code class=\"language-text\">private</code>이 더 적절하다고 생각했습니다.</p>\n</blockquote>\n<h2>프로그래밍 트랜잭션</h2>\n<p>선언적 트랜잭션은 사용할 수 없었기 때문에, <code class=\"language-text\">TransactionTemplate</code>을 이용해 프로그래밍 트랜잭션을 사용하였습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberService</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TransactionTemplate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transactionTemplate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Transactional</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(</span><span class=\"mtk10\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">seconds</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Runnable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">task</span><span class=\"mtk1\"> = () </span><span class=\"mtk4\">-&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeDefaultTeamMembersTeamToWithTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;정현모&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeDefaultTeamMembersTeamToWithTransaction</span><span class=\"mtk1\">(</span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">teamName</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">transactionTemplate</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransactionCallbackWithoutResult</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      @</span><span class=\"mtk10\">Override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">protected</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">doInTransactionWithoutResult</span><span class=\"mtk1\">(</span><span class=\"mtk10\">TransactionStatus</span><span class=\"mtk1\"> </span><span class=\"mtk12\">status</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">changeDefaultTeamMembersTeamTo</span><span class=\"mtk1\">(teamName);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>위와 같이 프로그래밍 트랜잭션을 사용하여 정상적으로 서비스가 돌아가는 것을 확인할 수 있었습니다.</p>\n<h2>테스트 코드 문제</h2>\n<p>이제 서비스 로직에선 잘 동작했지만, 이번엔 <strong>테스트 코드에서 문제</strong>가 발생했습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">SpringBootTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Transactional</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberServiceTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">() </span><span class=\"mtk4\">throws</span><span class=\"mtk1\"> </span><span class=\"mtk10\">InterruptedException</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">generateTeam</span><span class=\"mtk1\">(DEFAULT_NAME);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Team</span><span class=\"mtk1\"> </span><span class=\"mtk12\">changeTeam</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">generateTeam</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;정현모&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Member</span><span class=\"mtk1\"> </span><span class=\"mtk12\">member1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">generateMember</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">Member</span><span class=\"mtk1\"> </span><span class=\"mtk12\">member2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">generateMember</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// when</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">memberService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// wait task running</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Thread</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sleep</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2000</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(result).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SUCCESS&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">member1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTeam</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(changeTeam);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">member2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTeam</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(changeTeam);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>위 코드는 <code class=\"language-text\">기본 팀</code>과 바뀔 <code class=\"language-text\">정현모 팀</code>을 생성한 뒤에, 서비스 코드를 실행시키는 테스트입니다.</p>\n<p><code class=\"language-text\">Thread.sleep(2000)</code>으로 task가 완료될 충분한 시간을 준 뒤, <code class=\"language-text\">Team</code>이 제대로 바뀌었는지 확인하는 테스트입니다.</p>\n<p>하지만 수행시켜보면 <strong>아래와 같은 에러</strong>가 나타납니다.</p>\n<img width=\"932\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189484474-87c16cfb-5517-4fa3-a625-523d2fc7e2cd.png\">\n<p>오류의 내용은 **<code class=\"language-text\">\"정현모 팀\"</code>**을 찾을 수 없다는 내용입니다.</p>\n<p>분명히 <code class=\"language-text\">Team changeTeam = generateTeam(\"정현모\");</code> 코드를 통해 **<code class=\"language-text\">정현모 팀</code>**을 넣어줬는데, 왜 찾지 못할까요?</p>\n<p>원인은 바로 스케줄러가 새로운 스레드에서 돌면서 테스트 트랜잭션과 달리 <strong>완전히 새로운 트랜잭션</strong>으로 돌기 때문에 생긴 것입니다.</p>\n<p>그림으로 보겠습니다.</p>\n<img width=\"888\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189912300-2a7040d2-a392-45b8-ba6f-cc651e93ee79.png\">\n<p>그림에서 볼 수 있듯이 <code class=\"language-text\">스케줄러 트랜잭션</code>이 <code class=\"language-text\">테스트 트랜잭션</code>의 데이터를 볼 수 없는데, 그 이유는 <code class=\"language-text\">MySQL</code>의 기본 <code class=\"language-text\">Isolation Level</code> 때문입니다.</p>\n<h2>테스트가 실패한 원인을 찾자! <code class=\"language-text\">Isolation Level</code> 살펴보기</h2>\n<p><code class=\"language-text\">Isolation Level</code>은 크게 아래와 같이 4단계로 분류됩니다.</p>\n<h3>READ UNCOMMITTED</h3>\n<ul>\n<li>COMMIT 되지 않은 데이터에 다른 트랜잭션에서 접근할수 있다.</li>\n<li>INSERT, UPDATE, DELETE 후 COMMIT 이나 ROLLBACK에 상관없이 현재의 데이터를 읽어온다.</li>\n<li>ROLLBACK이 될 데이터도 읽어올 수 있으므로 주의가 필요하다.</li>\n</ul>\n<h3>READ COMMIITED</h3>\n<ul>\n<li>COMMIT 된 데이터에 다른 트랜잭션에서 접근할 수 있다.</li>\n<li>구현 방식이 차이 때문에 Query를 수행한 시점의 데이터와 정확하게 일치하지 않을 수 있다.</li>\n<li>LOCK이 발생하지 않는다.</li>\n</ul>\n<h3>REPEATABLE READ</h3>\n<ul>\n<li><strong>MySQL의 Default LEVEL</strong></li>\n<li>SELECT시 현재 시점의 스냅샷을 만들고 스냅샷을 조회한다.</li>\n<li>동일 트랜잭션 내에서 일관성을 보장한다.</li>\n</ul>\n<h3>SERIALIZE</h3>\n<ul>\n<li>가장 강력한 LEVEL</li>\n</ul>\n<p>이 중 3번째의 <strong>REPEATABLE READ</strong>를 보시면, <code class=\"language-text\">MySQL</code>의 기본 고립 수준인 것을 볼 수 있습니다.</p>\n<p>출처: <a href=\"https://labs.brandi.co.kr/2019/06/19/hansj.html\" target=\"_blank\" rel=\"nofollow\">MySQL의 Transaction Isolation Level (Lock에 관하여)</a></p>\n<h2>생각해 본 해결 방법 1 - <code class=\"language-text\">READ UNCOMMITED</code></h2>\n<p>해당 문제를 해결하기 위해 <code class=\"language-text\">READ UNCOMMITED</code>를 사용해보려고 했습니다.</p>\n<p><strong>예상 시나리오</strong>는 아래와 같습니다.</p>\n<img width=\"888\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189916238-c6906413-7097-4d58-a7b3-f79bb4c63352.png\">\n<p><code class=\"language-text\">스케줄러 트랜잭션</code>에서 <code class=\"language-text\">테스트 트랜잭션</code>의 커밋되지 않은 데이터를 보려면 고립 수준을 <code class=\"language-text\">READ UNCOMMITED</code>로 바꿔야 한다는 점에서 착안하였습니다.</p>\n<p>하지만 <code class=\"language-text\">READ UNCOMMITED</code>는 <code class=\"language-text\">Dirty Read</code> 문제가 있어 <strong>실제 프로덕션 코드</strong>의 고립 수준을 <code class=\"language-text\">READ UNCOMMITED</code>로 수정하면 <strong>데이터 정합성에 큰 문제</strong>가 발생할 수 있습니다.</p>\n<p>따라서 테스트 시의 트랜잭션 수행 코드와 프로덕션에서의 트랜잭션 수행 코드를 분리했습니다.</p>\n<p>아래와 같이 <code class=\"language-text\">@TestConfiguration</code>을 이용하여 테스트 시에 사용하는 트랜잭션 템플릿을 따로 만들어 주었습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">TestConfiguration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">RequiredArgsConstructor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">static</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TestSchedulerConfig</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">final</span><span class=\"mtk1\"> </span><span class=\"mtk10\">PlatformTransactionManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Bean</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">TransactionTemplate</span><span class=\"mtk1\"> </span><span class=\"mtk11\">schedulerTransactionTemplateTest</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">TransactionTemplate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">txTemplate</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TransactionTemplate</span><span class=\"mtk1\">(txManager);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">txTemplate</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setIsolationLevel</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TransactionDefinition</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ISOLATION_READ_UNCOMMITTED</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> txTemplate;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>테스트 코드에선 고립 수준을 <code class=\"language-text\">READ_UNCOMMITTED</code>로 설정해주는 것을 확인할 수 있습니다.</p>\n<p>테스트 코드에도 <strong>약간의 수정</strong>이 필요했습니다.</p>\n<p>바로 <code class=\"language-text\">em.flush()</code>와 <code class=\"language-text\">em.clear()</code>를 통해 실제 쿼리를 보내는 일입니다. 실제 쿼리가 나가서 DB가 업데이트 되어야 <strong>새로운 스레드의 트랜잭션에서 읽을 수 있기</strong> 때문입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">Test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">() throws InterruptedException {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// given</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">generateTeam</span><span class=\"mtk1\">(DEFAULT_NAME);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">Team</span><span class=\"mtk1\"> </span><span class=\"mtk12\">changeTeam</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">generateTeam</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;정현모&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">generateMember</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">generateMember</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 쿼리가 나가야 새로운 스레드의 트랜잭션에서 데이터를 읽을 수 있다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">em</span><span class=\"mtk1\">.</span><span class=\"mtk11\">flush</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">em</span><span class=\"mtk1\">.</span><span class=\"mtk11\">clear</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// when</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">String</span><span class=\"mtk1\"> </span><span class=\"mtk12\">result</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">memberService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>이론상 완벽하다..!</strong>\n<strong>테스트를 돌려보면…!</strong></p>\n<img width=\"999\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189489751-9bf67c84-fcd5-4031-b161-d1781c92e64c.png\">\n<p>기가 막히게 <strong>낙관적 락 에러</strong>를 일으킵니다.</p>\n<img width=\"515\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/189504868-559a64b3-78af-4aad-8a0a-dff946a0f1e2.png\">\n<p>쿼리를 보면, <code class=\"language-text\">update</code>문이 <strong>하나만 나가고 그 이후로 나가지 않고 있습니다.</strong> <code class=\"language-text\">member</code>가 2명이기 때문에 <code class=\"language-text\">update</code>문이 두 번 나가야 될 것 같은데 한 번만 나가고 다음 <code class=\"language-text\">update</code>문은 나가지 않고 있는 모습입니다.</p>\n<p>원인은 바로 <strong>DB단에서 row에 lock</strong>이 걸려있기 때문입니다.</p>\n<p><code class=\"language-text\">MySQL</code>이 사용하는 <code class=\"language-text\">InnoDB</code>는 서로 다른 트랜잭션에서 데이터를 수정할 수 없도록 <strong>각 <code class=\"language-text\">record</code>에 <code class=\"language-text\">Record lock</code>을 걸어 놓습니다.</strong></p>\n<p>그래서 <code class=\"language-text\">테스트 트랜잭션</code>의 <code class=\"language-text\">lock</code>을 기다리느라 <code class=\"language-text\">스케줄러 트랜잭션</code>에선 코드가 수행되지 않고 있었던 것입니다.</p>\n<p>그렇게 <code class=\"language-text\">테스트 트랜잭션</code>의 코드가 모두 수행되면 <strong>테스트의 데이터는 모두 롤백</strong>될 것이고, 이제서야 락을 획득한 <code class=\"language-text\">스케줄러 트랜잭션</code> 입장에선 <code class=\"language-text\">member</code>나 <code class=\"language-text\">team</code>의 데이터가 없어서 <code class=\"language-text\">ObjectOptimisticLockingFailureException</code>를 일으키는 것입니다.</p>\n<p>따라서 이 방법으론 테스트 코드 문제를 해결할 수 없었습니다.</p>\n<h2>생각해 본 해결 방법 2 - 새로운 스레드까지 트랜잭션을 전파</h2>\n<p>사실 <code class=\"language-text\">테스트 트랜잭션</code>을 <code class=\"language-text\">스케줄러 트랜잭션</code>까지 전파만 시킬 수 있다면 모두 해결 될 문제입니다. 아래 링크에 관련 정보도 있는 것 같은데, 아직 실력이 되지 않아 해당 내용을 이해하지 못했습니다.</p>\n<p><a href=\"https://stackoverflow.com/questions/5232351/how-to-propagate-spring-transaction-to-another-thread\" target=\"_blank\" rel=\"nofollow\">https://stackoverflow.com/questions/5232351/how-to-propagate-spring-transaction-to-another-thread</a></p>\n<h2>생각해 본 해결 방법 3 - 트랜잭션을 걸지 않고, 테스트 후 데이터 삭제</h2>\n<p>결국 가장 무식한 방법으로, 테스트에 트랜잭션을 걸지 않고 테스트 후에 데이터를 삭제하는 방식을 택했습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"java\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk10\">SpringBootTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//@Transactional // 트랜잭션 제거!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MemberServiceTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  @</span><span class=\"mtk10\">Test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk10\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reserveMemberTeamChange</span><span class=\"mtk1\">() </span><span class=\"mtk4\">throws</span><span class=\"mtk1\"> </span><span class=\"mtk10\">InterruptedException</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(result).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SUCCESS&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">List</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Member</span><span class=\"mtk1\">&gt; </span><span class=\"mtk12\">resultMembers</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">memberRepository</span><span class=\"mtk1\">.</span><span class=\"mtk11\">findAll</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">resultMembers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getTeam</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getId</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">changeTeam</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getId</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertThat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">resultMembers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getTeam</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getId</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">isEqualTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">changeTeam</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getId</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// after // 로직 수행 후 더미 데이터 모두 삭제!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">deleteAllMember</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">deleteAllTeam</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>무식하지만 깔끔하게 해결이 되었습니다.</p>\n<blockquote>\n<p>물론 더 좋은 방법이 있을 수 있지만, 우선 제가 이렇게 해결했다는 점을 봐주시면 감사하겠습니다. 더 좋은 방법이 있으면 댓글로 남겨주세요!</p>\n</blockquote>\n<p>전체 코드는 해당 링크에서 확인할 수 있습니다. <a href=\"https://github.com/gusah009/javaStudy/tree/master/webBlog\" target=\"_blank\" rel=\"nofollow\">https://github.com/gusah009/javaStudy/tree/master/webBlog</a></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"키퍼 홈페이지 트러블슈팅 - 스케줄러와 Transaction 그리고 테스트 코드에서 생긴 문제 해결하기","summary":"안녕하세요. 오늘은 스케줄러를 이용하면서 생긴 `LazyInitializationException`문제와 테스트 코드에서의 문제에 대해 작성해 보겠습니다.","date":"2022.09.08.","categories":["keeper_homepage"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAC2UlEQVQoz41SXUjTURT/3f++N4duTp0f86Ot/Kg2V07CFdUURaGUfAgMJSLsITRjYDHEB1/Wm4KRMghWOoMJfjAh5tjAhSPQbG7T/gwGe8i3HhKpnuLG/W9Sjx3u5Zx77j2/c37nXGjHLnPw3zJhoeci3nTrQI/RVqsWUQDHgI4CZylgokDl4M4O8IzC/vwzOpwxpWNsq+nmaORChzOm6XDG0P70A0BlIvm0TW+ApcSk7KxRAZCDg6JEJlMY+/sLH05Pn7s/NWVxHx0VUErRP/AEj95TzFNKGtqdGn1DZ2WGUsLuBEA9oKsFygGUiwAJAIXFbFaxB9FwuOZjLPZ1Mxik2UxmOJlMIpHYZ2+gO2NnitkaheESVOXnYR/fZT6oISJFhCMVkIrEer1eDoDzeDxVa2tr46FQKBoKheKRSGQuHA43Hx4eglJKWKBMopCBE2lvA6gCkEJOSglQkvfJzGazQC0ajXbzPE8zmcxPnue/B4NBenBw8Irdra+vi/Ox8upcrCDv8FdYRt3pwWq1IhAIiHieL/R6vWV9vb2ND4aGqm02WwWAIo7jNGKgCEDFNaDRCxjYEOkpgFhYKGW2xWIhqVQKHo9HNTc/3/TC7W4ed7nsoy7XDavV2gfARgi5DqAVQFOemZplqmcAwzlM0WmF2WyW297eRiKRcHza3aX7ySRN7+395jc2aDwef8kot7a0FBKOk0uAgjygVgpIhD5QgFwBpBAGDmI0GsUsKBAIlKXT6d4v6fSdTb//XtrrHVhbXWVVyYu1WrUCYF9Mdxeo/wUUg+NA6+oEQG0YYBXXEkAGQKlWq5UApAyYbeb7trws2D1dXYwNJ3gVClWDRFJBZ2aIfWKCvJ2dzfEdyvVQfdpTjUYjaAbweGREWm8yaZj94+SEXG1r+2eW4FjF7sFBhLa24FtczE3mNf5fHA4HJicnhWR+v1+7urJSubiwUONbWjL4fL7iP6CUCEpuJQcAAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/392f29220cb4a576e317fb9631269b91/26bcb/READ_UNCOMMITED.png","srcSet":"/static/392f29220cb4a576e317fb9631269b91/13868/READ_UNCOMMITED.png 444w,\n/static/392f29220cb4a576e317fb9631269b91/e715d/READ_UNCOMMITED.png 888w,\n/static/392f29220cb4a576e317fb9631269b91/26bcb/READ_UNCOMMITED.png 1776w","sizes":"(min-width: 1776px) 1776px, 100vw"},"sources":[{"srcSet":"/static/392f29220cb4a576e317fb9631269b91/531ec/READ_UNCOMMITED.webp 444w,\n/static/392f29220cb4a576e317fb9631269b91/5b0ba/READ_UNCOMMITED.webp 888w,\n/static/392f29220cb4a576e317fb9631269b91/4e632/READ_UNCOMMITED.webp 1776w","type":"image/webp","sizes":"(min-width: 1776px) 1776px, 100vw"}]},"width":1776,"height":1068}},"publicURL":"/static/392f29220cb4a576e317fb9631269b91/READ_UNCOMMITED.png"}}}}]}},"pageContext":{"slug":"/keeper-homepage/2022-09-08-스케줄러와 Transaction 그리고 테스트 코드에서 생긴 문제 해결하기/"}},"staticQueryHashes":[]}