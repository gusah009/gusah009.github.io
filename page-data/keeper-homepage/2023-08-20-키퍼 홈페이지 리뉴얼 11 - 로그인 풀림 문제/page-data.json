{"componentChunkName":"component---src-templates-post-template-tsx","path":"/keeper-homepage/2023-08-20-키퍼 홈페이지 리뉴얼 11 - 로그인 풀림 문제/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>키퍼 홈페이지를 개발하는데 로그인이 자꾸 풀린다고 연락이 왔습니다…</p>\n</blockquote>\n<p>오늘은 왜 로그인이 풀리는 문제가 발생했는지 한 번 알아보겠습니다.</p>\n<h3>키퍼 홈페이지 인증/인가</h3>\n<p>키퍼 홈페이지는 인증/인가에 JWT를 사용하고 있습니다.</p>\n<p><code class=\"language-text\">ACCESS TOKEN</code>, <code class=\"language-text\">REFRESH TOKEN</code>을 모두 사용하고 있고, 각각 만료시간이 2시간, 2주이기 때문에 정상적이라면 최소한 QA중에는 로그인이 풀려선 안됐다.</p>\n<p>그런데 이게 왠일인가… 2시간만 지났다 하면 로그인이 풀려버린다는 것이다.</p>\n<h3>기존 REFRESH TOKEN 동작 원리</h3>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814890-28e9d8e2-71aa-431e-b392-37b8e1ef15b2.png\" alt=\"image\"></p>\n<p>위 그림처럼 항상 모든 요청 앞에서 filter가 인증/인가를 진행하고, 비즈니스 로직 수행이 성공적으로 끝나면 header에 <code class=\"language-text\">Set-Cookie</code>로 각 토큰을 갱신해서 넣어주는 형식으로 진행했다.</p>\n<h3>디버깅</h3>\n<p><code class=\"language-text\">ACCESS_TOKEN</code>의 expired 시간을 1초로 만들어버리고 디버깅을 시작했다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814893-a9ff5b87-3fd6-4382-989e-cde963b5bcd4.png\" alt=\"image\"></p>\n<p>먼저 로그인을 해서 <code class=\"language-text\">토큰</code>들을 받아온 뒤, 1초 뒤에 만료가 되면 다른 API를 호출해보자.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">eyJhbGciOiJIUzI1NiJ9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.eyJzdWIiOiIxMzc2Iiwicm9sZXMiOiJST0xFX-2ajOybkCIsImlhdCI6MTY5MjUyMjA5NSwiZXhwIjoxNjkzNzMxNjk1fQ</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.ir1tz7IQt2JMfOrYfSmZFdJz0RSX9XSAwojLc5N-tK4</span></span></code></pre>\n<p>로그인 직후 <code class=\"language-text\">REFRESH_TOKEN</code> 은 위와 같다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814896-e2bf786b-77ae-4fc7-805c-898b43db143e.png\" alt=\"image\"></p>\n<p>API를 호출해봤더니 어라? 200 OK가 잘 떨어지고 결과도 잘 받아와졌다.</p>\n<p><del>개발팀에서 나한테 거짓말을 한걸까…?</del></p>\n<p>의아함을 가득 안고 다시 한 번 호출해봤다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814902-ff8479ae-e35c-4a41-b72a-5fa78f27cd9c.png\" alt=\"image\"></p>\n<p>아하… 2번째 호출부터 401 에러가 뜬다.</p>\n<p>이상해도 너무 이상하다… 첫 번째 호출땐 <code class=\"language-text\">REFRESH_TOKEN</code>이 잘 동작하면서 두 번째 API부턴 토큰이 정상 동작을 하지 않다니… 디버깅을 실시해봐야겠다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814941-fb3ce614-d213-4bb2-86c1-4fd44af50876.png\" alt=\"image\"></p>\n<p>필터에서 확인해봤을땐 <code class=\"language-text\">ACCESS_TOKEN</code>은 예상대로 만료되었는데, <code class=\"language-text\">REFRESH_TOKEN</code>이 Valid하다.</p>\n<p><code class=\"language-text\">REFRESH_TOKEN</code>이 valid하다면 정상적으로 동작해야하는데, 점점 미궁속으로 빠져들어간다…</p>\n<p>문득 <code class=\"language-text\">refreshToken</code>의 토큰값을 보게 되었는데, 요청으로 들어온 <code class=\"language-text\">REFRESH_TOKEN</code>의 값은 아래와 같았다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">eyJhbGciOiJIUzI1NiJ9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.eyJzdWIiOiIxMzc2Iiwicm9sZXMiOiJST0xFX-2ajOybkCIsImlhdCI6MTY5MjUyMjA5NSwiZXhwIjoxNjkzNzMxNjk1fQ</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.ir1tz7IQt2JMfOrYfSmZFdJz0RSX9XSAwojLc5N-tK4</span></span></code></pre>\n<p>이상한 점을 발견했다. 로그인 직후의 <code class=\"language-text\">REFRESH_TOKEN</code>의 값과 완전히 똑같다..!</p>\n<p>이게 왜 이상한 점이냐면, 로그인 이후 우리는 API를 한 번 호출했다.</p>\n<p>만약 정상동작을 했다면 API를 호출 했을 때 <code class=\"language-text\">ACCESS_TOKEN</code>이 만료되었기 때문에 <code class=\"language-text\">REFRESH_TOKEN</code>과 <code class=\"language-text\">ACCESS_TOKEN</code> 모두 갱신해주었어야 한다. 그런데 지금은 <code class=\"language-text\">REFRESH_TOKEN</code>의 값이 변하지 않은 것이다.</p>\n<p>더 이상한 점은, 설령 <code class=\"language-text\">REFRESH_TOKEN</code>의 값이 변하지 않았더라도 valid한 토큰이기 때문에 API는 정상 동작 해야한다는 점이다.</p>\n<h3>계속 디버깅…</h3>\n<p>디버깅 끝에 문제가 되는 곳을 찾았다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814947-e3237918-ed2b-482b-85fd-c7f3487a7936.png\" alt=\"image\"></p>\n<p>다른 조건은 다 통과하는데 **”<code class=\"language-text\">REFRESH_TOKEN</code>이 레디스에 있는가?”**에서 터지는 것이었다.</p>\n<p><strong>즉, 새로운 <code class=\"language-text\">REFRESH_TOKEN</code>으로 레디스엔 업데이트가 되었는데, 요청하는 API에선 옛날 <code class=\"language-text\">REFRESH_TOKEN</code>을 사용하다 보니 문제가 생긴 것이었다..!</strong></p>\n<p>여기서 든 생각은 “response에서 <code class=\"language-text\">Set-Cookie</code>가 제대로 안 도착했나?” 였는데,</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814948-74817b9d-b05d-4ea5-8af2-5fd5faf3220e.png\" alt=\"image\"></p>\n<p>세상에, 역시나 눈 씻고 찾아봐도 <code class=\"language-text\">Set-Cookie</code>가 없다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814952-5a7dff23-5e3d-4d82-a6d5-26b5e29c5dfa.png\" alt=\"image\"></p>\n<p>하지만 여기서 너무나도 정확하게 setCookie 넣어주고 있었는데… 머리가 아파오기 시작했다.</p>\n<p>더군다나 만약 이 함수에 문제가 있다면 로그인 시에도 쿠키는 적용이 되지 않았어야 한다. 왜냐면 <strong>로그인도 같은 함수를 사용중</strong>이기 때문이다..!</p>\n<p>하지만 결과에서 <code class=\"language-text\">Set-Cookie</code>가 되지 않았다고 말해주고 있었다. 얼른 저 <code class=\"language-text\">addHeader</code> 함수를 디버깅하기 시작했다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814957-4ff19a18-011d-4353-a480-1ce4f454ee45.png\" alt=\"image\"></p>\n<p>break point 등록 !</p>\n<h3>원인 발견</h3>\n<p>드디어 원인을 찾아냈다.</p>\n<p>정체를 알 순 없지만 저 <code class=\"language-text\">isCommitted</code> 에서 true가 나오면 실제로 <code class=\"language-text\">addHeader</code>를 하지 않는다는걸 발견했다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814984-7a15c390-9baf-486a-9fdc-4e17c4d8a0b5.png\" alt=\"image\"></p>\n<p>더 파고 들어봤더니,</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814987-091f4067-d401-4c6f-bf67-55c0e8ad0f6b.png\" alt=\"image\"></p>\n<p>이게 무슨일인가… committed가 true이지 않은가…</p>\n<p><strong>이 알 수 없는 함수 덕분에 <code class=\"language-text\">addHeader</code>는 하는 척만 하고 실제로 header에 추가되지 않았던 것이다</strong></p>\n<p>도대체 이 <code class=\"language-text\">this.appCommitted</code> 값은 어디서 바뀌는걸까? 집요하게 파들어가봤다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814990-55b07f83-5399-401c-ba1a-cdc2724b8499.png\" alt=\"image\"></p>\n<p>값이 바뀌는 유일한 지점. break point를 걸어두고 두 눈 부릅뜬채 지켜봤다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271814995-de782c3b-2414-45a2-bdcc-b275e59f1c23.png\" alt=\"image\"></p>\n<p>세상에.. 이 appCommitted는 원래 false였는데, 어느 순간 true로 만드려고 하는걸 break point를 통해 잡아냈다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271815000-e0adcc64-f2fa-4e77-918b-5b37031a74f1.png\" alt=\"image\"></p>\n<p>이제 이 디버거의 길고 긴 스택 트레이스를 따라 범인을 찾으면 된다.</p>\n<p>한 눈에 봐도 수상한 <code class=\"language-text\">flush</code>를 발견했다.</p>\n<p>이 함수가 하는 일은 <strong>Header들을 Write 하고 body를 사용한다면 <code class=\"language-text\">response</code>객체에 <code class=\"language-text\">flushBuffer</code>를 해버린다…!!</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271815021-9345c095-b40c-489a-9097-8a34265824d5.png\" alt=\"image\"></p>\n<p><strong>즉, body가 response로 내려가기 전에 헤더 먼저 응답으로 보내버린다는 것이다…!</strong></p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271815027-9c372fa0-147c-4a27-b0cb-15f3e949394b.png\" alt=\"image\"></p>\n<p><strong>더 충격적인건 이 <code class=\"language-text\">flush</code>가 호출되는 시점이 <code class=\"language-text\">refreshTokenFilter</code>가 끝나기 전이라는 뜻이다.</strong></p>\n<p>무슨 말인지 이해가 어려울 수 있으니 그림으로 설명해봤다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271815033-1769fb9b-da71-4d14-b868-f3376f7e50d5.png\" alt=\"image\"></p>\n<p>세상에 스프링 MVC에 이런 기능이 있다니… 처음 알게 되었다…</p>\n<h3>해결</h3>\n<p>해결은 매우매우 간단했다… ㅎㅎ…</p>\n<p><code class=\"language-text\">doFilter</code>가 호출되기 전에 header에 <code class=\"language-text\">Set-Cookie</code>를 해주면 되는 것이다.</p>\n<p>과거의 내가 왜 <code class=\"language-text\">doFilter</code>를 기점으로 저렇게 나눠놨는지 모르겠지만 어쨋든 해결…!</p>\n<p><img src=\"https://user-images.githubusercontent.com/26597702/271815030-6d853634-3aed-4d75-bb64-b0adc1c2e680.png\" alt=\"image\"></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"키퍼 홈페이지 리뉴얼 11 - 로그인 풀림 문제","summary":"키퍼 홈페이지를 개발하는데 로그인이 자꾸 풀린다고 연락이 왔다…","date":"2023.08.20.","categories":["keeper_homepage"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEMUlEQVRIx5WVyW7bVhiFteprZd2X6LbbokALtEBfodsuWrRB20x2JifR4FmOrcESKYkUqZnzJGq2HDkF2uQrSNWOgyqJfIFDEhzOPZf/Of9NPCsbbBQNkmWNp8cKG/vV+Pw832SnYrItGjGi63WQ+O2wzu2nf3L3pMOB0Ob5scTjrMTWicpu1boRWUz4pNDhl3SOo0aA67oEgzGHdY+0YJARjCuVaxPuVS32ai6Hko3hj/BG55x2+hRaPtm6c3OFOxWDdFnnpeIShCNKpRJhGDKfTWjbA5Jlnd0bqExEh4xoxAqtYIJmB5j+kGA0o2GN4me7Kz780ARLQkHnpephuT6CKKKoDdrtDl4wYF+yeXGqkSrrpMrL82XlL0mvk18pPJBs7HCK7vbR3RAnHOMNzxB6A4rtfoxyd0ChFbBbNdmpWiuVXik8Vj1s10fXNWqShKqqmKZJu9VE63XxPY9mQ8W0LE5Uj2f5FjurFEb/JyXaZGWHptmnoblUmzpK16ahe0htE7ljU+86lOsd5K5DptRh86AaC/kf4f18l3tHp2zk2tzfq3A7WeDeXoXNbJ2UaJEUTNKCSaZisVN1yIiR2c3Y9CuX/PuhzE8P/uBJ2aRtBtRaRqxG6Tn0vDG6P0HoBKRjNcYVPliUqCCPChq5ZoBpOQiCgCzL1Go1giBg2PfouiOSJX2lfVbaZreyrLIRRJWdYffH9MdzOu6EnOpydIPExIRRUk4aAc12F0EQOS0L6JqG1p/z8LjNi5IWv7NO93nPh85ghh2McAdT/OEMwx/T9abowRSx148bxnoKo6QoHo4fUBYEJFlG143Yh67jMBqEGMGU1LqE0RL2axb98YL5+d+E01cMZguGZxeE0wWT87+Q9EEcu7WyHCnMKwHmqwDjtcPlODubYVkmvmvTtIaxwih2H/2HcWsSDI7rHoOLc5zXQ968gX/ewmx+TjgcMZvNkLWAuzsCyWL7o508Ee0pD0tGXMlUvknypcrznEqq2CJbd68QWStV6q008/t7yoHMr5s/c+ekQ7bSJV1Q2C6q7Asd8k2fQtOn1AnJyvYnyWLCrWKP23s1DhSf8WTKYrHg+lgsLjg/m9HxJnGmry83yvROJSqU9h8MEsuQW3H0gn4Yt6rleBsf5/M542FI0wp5sF8jU9auqTTIiD5pMSQlhmREl8Sl86PiVPUhsjmm0utT6YUxavoAxZ5wJFtsnTTYFrQrVZHCYynLaf1pjMOquCS8nDHyWbJ02e7fIboX7y1Vi4zoxYrSok+qckFP/pz8kwT2aYJu54d3xv5UAnbjtuVyVCtSlB9TkLbISxm6jS8x6rdwmrco1TeWhB/D5WSZcovHuQF66wteqQn6lQTTeoJ+NUEofcZUSVBv/Lg+YbLYYvOwRaF6h1bjaxTle1TlOxrKtzSUb2ipX5GTtvkXxMfIbym5B7gAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/e7f1b3e31400c679ce83202a8a36cc60/fd953/DB_gone.png","srcSet":"/static/e7f1b3e31400c679ce83202a8a36cc60/8496c/DB_gone.png 190w,\n/static/e7f1b3e31400c679ce83202a8a36cc60/f7d88/DB_gone.png 380w,\n/static/e7f1b3e31400c679ce83202a8a36cc60/fd953/DB_gone.png 760w","sizes":"(min-width: 760px) 760px, 100vw"},"sources":[{"srcSet":"/static/e7f1b3e31400c679ce83202a8a36cc60/29fd1/DB_gone.webp 190w,\n/static/e7f1b3e31400c679ce83202a8a36cc60/8bde1/DB_gone.webp 380w,\n/static/e7f1b3e31400c679ce83202a8a36cc60/4a77a/DB_gone.webp 760w","type":"image/webp","sizes":"(min-width: 760px) 760px, 100vw"}]},"width":760,"height":1084}},"publicURL":"/static/e7f1b3e31400c679ce83202a8a36cc60/DB_gone.png"}}}}]}},"pageContext":{"slug":"/keeper-homepage/2023-08-20-키퍼 홈페이지 리뉴얼 11 - 로그인 풀림 문제/"}},"staticQueryHashes":["2518467932","429584967"]}