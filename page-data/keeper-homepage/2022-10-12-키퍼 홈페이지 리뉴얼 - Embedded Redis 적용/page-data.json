{"componentChunkName":"component---src-templates-post-template-tsx","path":"/keeper-homepage/2022-10-12-키퍼 홈페이지 리뉴얼 - Embedded Redis 적용/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>오늘은 프로젝트에 Embedded Redis와 방법을 적용한 사례를 말씀드리겠습니다.</p>\n</blockquote>\n<p>포스팅에 들어가기 앞서 두 포스팅의 글을 많이 참고했음을 밝힙니다.</p>\n<ul>\n<li><a href=\"https://www.baeldung.com/spring-embedded-redis\" target=\"_blank\" rel=\"nofollow\">Embedded Redis Server with Spring Boot Test</a></li>\n<li><a href=\"https://jojoldu.tistory.com/297\" target=\"_blank\" rel=\"nofollow\">[Redis] SpringBoot Data Redis 로컬/통합 테스트 환경 구축하기</a></li>\n</ul>\n<h2>Embedded Redis</h2>\n<p><code class=\"language-text\">Embedded Redis</code>는 <code class=\"language-text\">Java</code> 내부적으로 Redis를 실행시키고 사용함으로써 Redis 서버를 따로 띄우지 않아도 됩니다.</p>\n<p>우연히 <code class=\"language-text\">Embedded Redis</code>의 존재를 알게 됐고, 매번 테스트를 돌릴 때 마다 로컬에서 Redis 서버를 여느니 <strong>편의를 위해서 테스트만이라도 내장 Redis를 사용하기로 했습니다.</strong></p>\n<h2>몇 번의 시행착오</h2>\n<h3>TestConfiguration 사용해보기</h3>\n<p>처음엔 <a href=\"https://www.baeldung.com/spring-embedded-redis\" target=\"_blank\" rel=\"nofollow\">밸떵님 블로그</a>를 참고해서 <code class=\"language-text\">TestConfiguration</code>으로 테스트시에만 <code class=\"language-text\">Embedded Redis</code>를 사용하고자 했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@TestConfiguration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestRedisConfiguration</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.redis.port}\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">RedisServer</span> redisServer<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">TestRedisConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisServer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisServer</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@PostConstruct</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postConstruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    redisServer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@PreDestroy</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">preDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    redisServer<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 문제가 있었는데, 바로 <code class=\"language-text\">@SpringBootTest</code>는 <code class=\"language-text\">@TestConfiguration</code>을 자동으로 <code class=\"language-text\">ComponentScan</code> 해주지 않는다는 것이었습니다.</p>\n<p><code class=\"language-text\">Redis</code>를 <strong>사용하는 테스트에 명시적으로</strong> <code class=\"language-text\">@SpringBootTest(classes = TestRedisConfiguration.class)</code> 해주어야만 했습니다.</p>\n<p>하지만 저희 프로젝트에서 사용하는 <code class=\"language-text\">@SpringBootTest</code> 어노테이션이 여기저기 많기도 했고, 무엇보다 만약 새로 추가하는 테스트에서 깜빡하고 명시적으로 <code class=\"language-text\">Configuration</code>을 선언해주지 않아 에러가 발생한다면 <strong>다른 사람이 이 부분에서 많은 시간을 디버깅하는데 허비할 것이라 생각했습니다.</strong></p>\n<p>결국 다른 방법으로 <code class=\"language-text\">Embedded Redis</code>를 적용하고자 했습니다.</p>\n<h3>의존성 문제와 maxmemory 문제 해결</h3>\n<p>위와 같은 문제 외에도 <strong>라이브러리 자체 문제</strong>가 몇 개 있었는데, 해당 문제들은 <a href=\"https://jojoldu.tistory.com/297\" target=\"_blank\" rel=\"nofollow\">향로님의 블로그</a>에서 잘 해결해주고 계셔서 링크만 남깁니다.</p>\n<h3>통합 테스트에서 Embedded Redis 포트충돌 문제</h3>\n<p>이 문제도 <a href=\"https://jojoldu.tistory.com/297\" target=\"_blank\" rel=\"nofollow\">향로님의 블로그</a>에서 해결해주고 있지만 조금 더 깔끔한 코드로 해결하여서 제 코드를 올려볼까 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.redis.host}\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> host<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.redis.port}\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@Bean</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisConnectionFactory</span> <span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LettuceConnectionFactory</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> <span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Bean</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>port <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> port <span class=\"token operator\">=</span> <span class=\"token function\">findAvailablePort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> port<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">findAvailablePort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">getLocalPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Port is not available\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getPort()</code> 메서드와 <code class=\"language-text\">findAvailablePort()</code> 메서드를 제외하면 <strong>기본적인 redis 설정 코드</strong>입니다.</p>\n<p>전 통합 테스트시 포트 충돌을 막기 위해 <code class=\"language-text\">getPort()</code> 메서드로 포트를 가져오게끔 하고, <strong>테스트 시에는 테스트 <code class=\"language-text\">application.properies</code>의 <code class=\"language-text\">spring.redis.port</code> 값을 -1로 주어서 빈 포트를 찾아 할당하도록 하였습니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableRedisRepositories</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestRedisConfiguration</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisConfig</span> redisConfig<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">RedisServer</span> redisServer<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@PostConstruct</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postConstruct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisServer <span class=\"token operator\">=</span> <span class=\"token class-name\">RedisServer</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">port</span><span class=\"token punctuation\">(</span>redisConfig<span class=\"token punctuation\">.</span><span class=\"token function\">getPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setting</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"maxmemory 128M\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    redisServer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@PreDestroy</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">preDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>redisServer <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      redisServer<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>또, <code class=\"language-text\">Profile</code>이 <code class=\"language-text\">\"test\"</code>일 때만 실행되는 <code class=\"language-text\">TestRedisConfiguration</code> 코드에 <code class=\"language-text\">Embedded Redis</code>를 사용할 수 있도록 설정해 놓았습니다.</p>\n<p>이렇게 하면 테스트의 모든 <code class=\"language-text\">@SpringBootTest</code>마다 명시적으로 <code class=\"language-text\">@SpringBootTest(classes = TestRedisConfiguration.class)</code> 해 줄 필요도 없고, 테스트 시에는 <code class=\"language-text\">Embedded Redis</code>로, 배포 시에는 <code class=\"language-text\">외부 Redis</code>로 사용할 수 있게 됩니다.</p>","frontmatter":{"title":"키퍼 홈페이지 리뉴얼 - Embedded Redis 적용","summary":"오늘은 프로젝트에 Embedded Redis를 적용한 사례와 방법을 말씀드리겠습니다.","date":"2022.10.12.","categories":["keeper_homepage"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADNklEQVQ4y4VU25abOBD0Z8Qg0P3GHQwGPHYyzuzs/v8X1R4J2zNZJ7MPdSQeKHV1VfdOO4vqskK3Nfw8wo497NDBHjpQSpHu9yBJCpIkIGmKPM+RZRny/PfYCaNRv57hlwnlZUX1eoF7WeDPK8x0gDn02yPjAFWVN7L8CdmdUFmD+nqOFdlpQDl16LoCfV+j6Ssop8GUAtcKTIqt2jRFlpLtJATkVnEWCY1BMa+w/QjddvBtg6au0ZQeZe1gaw/hHIQ14EZDlgVk4SC8jWd4SPLQhq3SHeMcphqhfAcuLbjyUM2MTCiIuoS+VW6GDrprYIYWfj0+7qr0MIp+EIbGZxlBzmgEpRk4zaGVgpISSkjw0KN0kxpxM+hJcpZhR/M8yqmvF7h5QnWocVom/PX+jre3N7z//Q9e1glKUpAs/60hv5gSCJnUMM0E2x5huwW27+CnAcUyoVlWHC8/UbUdCElvBF/EhgWpWR5di2fOooSUEGSMgXIOxgUYY58i8wVhqJArCb+O0H0NVxlMfYPXH69oCoOcfEMaenUn+yLUH4Rao5hPcOOCYjyiOxwxnb5jmCa04xFS6T8G+pmQUlDGH5HhugAVGiQXsEUNVzaQUoIQcnM2uSGNPd3i8h/CPKegXIIJtUFJCKtBpQBVIn4zIaCth/EljCugrIPU5jEh92o3l4WCqceb0zNMcHk9wh56uHmMoVbeY1guOJx+YDxf0S8XdOMMFnP8iTC4Fxody78hfu+TGGZKCGj4ISNIkj2S/bcH0jR52j47wUP/NFx/ihCuBndtzN31OuPyfcZp7dDVEsLIuNI+4xeDwqRIETJGwZWFKnv0Q4vx8hNFVaH0Dt5pNG0JknMkSYIkSSP2+497GjYPIZ8k063sMDH18YxiOMFWHYb1gqobUFUFpuOAl5cRyzJgmjqczxPW9YD52KPpS2in42DsOOegNAdlYgOXGxiPrnKpojTnNIrCwnuDsnSoKx/v1mpoq6CMeiaUvgVXBlzIGA+l7WOLBFlhYu7nZ6l3ZHfJNKwtxrboBBRNjEXVHRAe/POUPE/NTnABLjmYZEiTPUi6j1MQY5EkD7Lsf2b4Hpt/AWQFcPPjnm9EAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/46bd6d5b938bed6cc47dc8c672c3f801/5e880/redis_test_configuration.png","srcSet":"/static/46bd6d5b938bed6cc47dc8c672c3f801/7f5ca/redis_test_configuration.png 207w,\n/static/46bd6d5b938bed6cc47dc8c672c3f801/1bf36/redis_test_configuration.png 413w,\n/static/46bd6d5b938bed6cc47dc8c672c3f801/5e880/redis_test_configuration.png 826w","sizes":"(min-width: 826px) 826px, 100vw"},"sources":[{"srcSet":"/static/46bd6d5b938bed6cc47dc8c672c3f801/d8fa0/redis_test_configuration.webp 207w,\n/static/46bd6d5b938bed6cc47dc8c672c3f801/c73bd/redis_test_configuration.webp 413w,\n/static/46bd6d5b938bed6cc47dc8c672c3f801/6454a/redis_test_configuration.webp 826w","type":"image/webp","sizes":"(min-width: 826px) 826px, 100vw"}]},"width":826,"height":888}},"publicURL":"/static/46bd6d5b938bed6cc47dc8c672c3f801/redis_test_configuration.png"}}}}]}},"pageContext":{"slug":"/keeper-homepage/2022-10-12-키퍼 홈페이지 리뉴얼 - Embedded Redis 적용/"}},"staticQueryHashes":[]}