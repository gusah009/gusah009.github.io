{"componentChunkName":"component---src-templates-post-template-tsx","path":"/keeper-homepage/2022-08-16-키퍼 홈페이지 리뉴얼 6 - 개발 도중 생긴 이슈들 1/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>오늘은 개발 도중에 생긴 이슈에 대해 말씀드리겠습니다.</p>\n</blockquote>\n<h2>Entity와 Dto 분리</h2>\n<p>개발 초기 코드와 함께 <code class=\"language-text\">Entity</code>와 <code class=\"language-text\">Dto</code>를 분리시킨 과정에 대해 말씀드리겠습니다.</p>\n<p>당시 저희의 코드는 아래와 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Log4j2</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberController</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberService</span> memberService<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"/members\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MemberEntity</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> memberService<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그저 <strong>모든 멤버를 찾아 가져오는 API</strong>였습니다.</p>\n<p>안타깝게도 API가 반환하는 <code class=\"language-text\">MemberEntity</code>에는 <code class=\"language-text\">TeamEntity</code>가 연관관계로 잡혀있었고, <code class=\"language-text\">TeamEntity</code>역시 <code class=\"language-text\">MemberEntity</code>를 참조하고 있었습니다.</p>\n<p>그런 API를 호출하면 <strong>시원하게 <code class=\"language-text\">StackOverFlow</code> 를 일으킵니다.</strong></p>\n<img width=\"770\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/195082865-f4af5294-3934-4dbd-acbe-a37f8f0223ba.png\">\n<br>\n<img width=\"800\" alt=\"image\" src=\"https://user-images.githubusercontent.com/26597702/195083211-c9982f34-372d-4076-89ac-6562de3f0d3d.png\">\n<p>이유는 <code class=\"language-text\">Entity</code>를 <code class=\"language-text\">Json</code>으로 변환하면서 <code class=\"language-text\">MemberEntity</code>와 <code class=\"language-text\">TeamEntity</code>가 <strong>서로 순환참조하여 무한히 호출했기 때문입니다.</strong></p>\n<p>이에 <code class=\"language-text\">@JsonIgnore</code>도 걸어보기도 하고, <code class=\"language-text\">@JsonBackReference</code>도 걸어보기도 했지만 사실 그럴 필요 없이, <code class=\"language-text\">Entity</code> 대신 <code class=\"language-text\">Dto</code>를 반환하면 되는 문제였습니다.</p>\n<p><code class=\"language-text\">Entity</code>를 바로 반환하는 건 많은 단점을 야기합니다.</p>\n<ol>\n<li>위와 같이 양방향 연관관계를 가질 때 <strong>무한 순환참조</strong>가 일어난다.</li>\n<li><code class=\"language-text\">Entity</code>를 그대로 API에 드러내어 해커가 <strong>내부 컬럼이나 데이터 구조를 쉽게 파악할 수 있다.</strong></li>\n<li>API 스펙을 변경하기가 어렵다. 데이터 구조가 바뀌어 <code class=\"language-text\">Entity</code>가 바뀌면 관련 <code class=\"language-text\">Entity</code>를 사용하는 API 모두의 스펙이 바뀐다.</li>\n</ol>\n<p>위와 같은 단점들로 인해 <code class=\"language-text\">Entity</code>를 그대로 반환해주던 방식에서 <code class=\"language-text\">Dto</code>를 반환해주던 방식으로 변경하였습니다.</p>\n<blockquote>\n<p>이후 김영한님의 강의를 듣다가 관련 내용이 나왔습니다. 김영한님 역시 <code class=\"language-text\">Entity</code> 대신 <code class=\"language-text\">Dto</code>를 반환하는게 좋다고 말씀하셨습니다.</p>\n</blockquote>\n<blockquote>\n<p>지금 보면 너무 당연한 코드지만, 이 프로젝트가 시작 된 9개월 전까지만 해도 자바나 스프링, 웹에 대해 <strong>전혀 모르던 상태</strong>였습니다.</p>\n</blockquote>\n<h3>mapstruct 적용과 철회</h3>\n<p>그렇게 <code class=\"language-text\">Entity</code>와 <code class=\"language-text\">Dto</code>들을 서로 분리해서 만들어 주던 중에, 이런 생각이 들었습니다.</p>\n<blockquote>\n<p>“Entity랑 반환하는 Dto가 거의 비슷한데, 이걸 굳이 매번 새로 만들어야 하나?”</p>\n</blockquote>\n<p>그래서 찾아보던 중 <code class=\"language-text\">mapstruct</code>라는 것을 발견했습니다. (<a href=\"https://mapstruct.org/\" target=\"_blank\" rel=\"nofollow\">공식 문서</a>)</p>\n<p>이름처럼 <code class=\"language-text\">Entity</code>와 <code class=\"language-text\">Dto</code>같이 비슷한 객체를 매핑시켜주는 라이브러리였고, 딱 저희에게 필요한 라이브러리였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Mapper</span><span class=\"token punctuation\">(</span>componentModel <span class=\"token operator\">=</span> <span class=\"token string\">\"spring\"</span><span class=\"token punctuation\">,</span> unmappedTargetPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">ReportingPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IGNORE</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonMemberMapper</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">CommonMemberDto</span> <span class=\"token function\">toDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MemberEntity</span> memberEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">MemberEntity</span> <span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonMemberDto</span> memberDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드처럼 <code class=\"language-text\">Mapper</code> 추상화 클래스를 만들어서 컴파일하면 아래와 같이 자동으로 변환 클래스를 만들어 주었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonMemberMapperImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">CommonMemberMapper</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">CommonMemberDto</span> <span class=\"token function\">toDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MemberEntity</span> memberEntity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> memberEntity <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">CommonMemberDto</span> commonMemberDto <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CommonMemberDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    commonMemberDto<span class=\"token punctuation\">.</span><span class=\"token function\">setId</span><span class=\"token punctuation\">(</span> memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    commonMemberDto<span class=\"token punctuation\">.</span><span class=\"token function\">setNickName</span><span class=\"token punctuation\">(</span> memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">getNickName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    commonMemberDto<span class=\"token punctuation\">.</span><span class=\"token function\">setGeneration</span><span class=\"token punctuation\">(</span> memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">getGeneration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> commonMemberDto<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberEntity</span> <span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonMemberDto</span> memberDto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> memberDto <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">MemberEntityBuilder</span> memberEntity <span class=\"token operator\">=</span> <span class=\"token class-name\">MemberEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">id</span><span class=\"token punctuation\">(</span> memberDto<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">nickName</span><span class=\"token punctuation\">(</span> memberDto<span class=\"token punctuation\">.</span><span class=\"token function\">getNickName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">generation</span><span class=\"token punctuation\">(</span> memberDto<span class=\"token punctuation\">.</span><span class=\"token function\">getGeneration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> memberEntity<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>당연히 변수명이나 추가하고 싶은 컬럼들을 커스터마이징 할 수 있었고, 바로 프로젝트에 도입했습니다.</p>\n<h3>mapstruct의 단점</h3>\n<p>하지만 사용하다 보니 단점이 드러났는데,</p>\n<ol>\n<li>위와 같이 <code class=\"language-text\">Entity</code>, <code class=\"language-text\">Dto</code>가 단순하면 상관 없지만 <strong>복잡해 질수록 고려해야 할 점이 많아진다.</strong></li>\n<li>수동으로 진행할 때에는 컴파일 시점에 오류를 잡을 수 있지만 <strong><code class=\"language-text\">mapstruct</code>는 런타임이 되어야 오류를 잡을 수 있다.</strong></li>\n</ol>\n<p>와 같은 단점이 있었습니다.</p>\n<p>특히 2번이 큰 단점으로 다가왔는데, <code class=\"language-text\">mapstruct</code>는 매핑을 할 때 존재하지 않는 컬럼을 커스터마이징 하려면 <strong>아래와 같이 문자열로 표현해야 합니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Mapping</span><span class=\"token punctuation\">(</span>target <span class=\"token operator\">=</span> <span class=\"token string\">\"jobs\"</span><span class=\"token punctuation\">,</span> \n    expression <span class=\"token operator\">=</span> <span class=\"token string\">\"java(memberEntity.getJobs())\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 문자열로 메서드 호출을 한다!!</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">CommonMemberDto</span> <span class=\"token function\">toDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MemberEntity</span> memberEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>문자열로 표현</strong>하다 보니 컴파일 타임에 문제가 잡히지 않는 것이 큰 단점으로 다가왔습니다.</p>\n<p>결국 <code class=\"language-text\">mapstruct</code>를 철회하고 수동으로 <code class=\"language-text\">from()</code>, <code class=\"language-text\">toEntity()</code>를 만들어 사용했습니다.</p>\n<blockquote>\n<p>여담이지만, 아래 코드와 같이 <code class=\"language-text\">toEntity()</code>라는 메서드를 <code class=\"language-text\">Dto</code> 클래스가 가지면서 오히려 직관적이게 되었습니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberDto</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> loginId<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> password<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Dto의 내용을 담아 Entity로 변환해주는 메서드!!</span>\n  <span class=\"token comment\">// mapper.toEntity(memberDto) 보다 memberDto.toEntity()로 조금 더 직관적이게 변했다!</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberEntity</span> <span class=\"token function\">toEntity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">MemberEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">loginId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loginId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">password</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>다음으로..</h2>\n<p>다음 포스팅에서는 <strong>출석이 2번 되던 버그</strong>에 대해 글을 작성해 보겠습니다!</p>\n<p>그럼 좋은 하루 보내세요~~!</p>","frontmatter":{"title":"키퍼 홈페이지 리뉴얼 6 - Entity와 Dto, mapstruct 적용과 철회","summary":"오늘은 개발 도중에 생긴 이슈에 대해 말씀드리겠습니다.","date":"2022.08.16.","categories":["keeper_homepage"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVQ4y72Sa07EMAyEex12EzuvJn0j7n+oQeOqS1cCVouAH5YTj535krZb1jfMyyvGaYWGjKtTXK7yERe5338SL+xxipwaOlVFShkpJTjnLdfaIKIQVeScoRpM47rWCs6wFmOyzN5hGOBFeKAgxohSMkQEpRRM02RDISj6vjfde2/rcRwRQrCgATX2LstitY4FNtKZ69Ya5nk2Ugadd8qd4tAOWmbut22zbFfmQRR2wnwjZJD4O0Jm9tHojpBkByHxz4Q0ORPm/BRh+RHhf77hc4Qx/hHhuq6PCen4mPCL/7C1XyIk1e6WjJAN5zc8vqRz7kZ4aDyAGudoxNo7OGWdzDcZ//gAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/c53e18276d78b1291a4ab2d34daddf9f/1ac00/infinite_reference.png","srcSet":"/static/c53e18276d78b1291a4ab2d34daddf9f/b0bc2/infinite_reference.png 736w,\n/static/c53e18276d78b1291a4ab2d34daddf9f/f0ff5/infinite_reference.png 1472w,\n/static/c53e18276d78b1291a4ab2d34daddf9f/1ac00/infinite_reference.png 2944w","sizes":"(min-width: 2944px) 2944px, 100vw"},"sources":[{"srcSet":"/static/c53e18276d78b1291a4ab2d34daddf9f/bd531/infinite_reference.webp 736w,\n/static/c53e18276d78b1291a4ab2d34daddf9f/10f56/infinite_reference.webp 1472w,\n/static/c53e18276d78b1291a4ab2d34daddf9f/7619a/infinite_reference.webp 2944w","type":"image/webp","sizes":"(min-width: 2944px) 2944px, 100vw"}]},"width":2944,"height":1894}},"publicURL":"/static/c53e18276d78b1291a4ab2d34daddf9f/infinite_reference.png"}}}}]}},"pageContext":{"slug":"/keeper-homepage/2022-08-16-키퍼 홈페이지 리뉴얼 6 - 개발 도중 생긴 이슈들 1/"}},"staticQueryHashes":[]}