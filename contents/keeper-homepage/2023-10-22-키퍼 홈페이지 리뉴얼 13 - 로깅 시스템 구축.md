---
date: '2023-10-22'
title: '키퍼 홈페이지 리뉴얼 13 - 로깅 시스템을 구축해보자! (with SIGNOZ not ELK)'
categories: ['keeper_homepage']
summary: '최근에 키퍼 홈페이지에 로그 분석 시스템이 필요하다고 느꼈습니다.'
thumbnail: './thumbnail/signoz.webp'
---

> 최근에 키퍼 홈페이지에 로그 분석 시스템이 필요하다고 느꼈습니다.

드디어 키퍼 홈페이지 리뉴얼2가 배포됐습니다.

무려 하루 사용자가 50명이나 되는 서비스가 됐는데요.

사용자가 많아지면서 버그도 많아지고 트러블슈팅용 로그 모니터링 시스템이 필요해졌습니다.

## ELK

처음에 생각한건 제일 유명한 ELK였는데, 저희 조그마한 서버의 스펙으론 버틸수 없겠더라구요.

<img width="562" alt="image" src="https://user-images.githubusercontent.com/26597702/277145580-bb31a7ff-60b8-44e2-9a56-dd7a98524314.png">

> 우리의 작은 서버 스펙 (t3.small)

<img width="222" alt="스크린샷 2023-10-22 13 41 58" src="https://user-images.githubusercontent.com/26597702/277145625-ca02b41c-8e6b-478b-bd19-149fe24b8891.png">

그래서 한 번 가벼운 ELK가 있을 지 찾아봤습니다.

<img width="519" alt="image" src="https://user-images.githubusercontent.com/26597702/277145647-ac697a8d-8300-4584-a3da-825beccdfba7.png">

제일 상단에 뜨는 `signoz`. 대놓고 **ELK의 경량화 대안**이라고 소개를 하고 있으니 한 번 써보도록 하겠습니다.

## signoz

signoz는 로그 뿐만 아니라 메트릭, 애플리케이션간의 추적도 지원하는데요, 이런 모든 중요한 모니터링을 하나의 대시보드에 통합해서 **운영 오버헤드를 줄일 수 있다**고 소개하고 있습니다.

또, 오픈소스이기도 하고 `k8s`, `Helm`, `prometheus` 같은 기술들을 지원하는 단체인 `CNCF(Cloud Native Computing Foundation)`에서 지원하는 기술이기도 합니다.

흥미로웠던건, README에서 **타 기술들과 자신의 차이점(장점)을 공공연하게 드러내고 있더라구요.** (https://github.com/SigNoz/signoz#comparisons-to-familiar-tools)

> 마치 `gradle`이 처음 나왔을 때 `maven`과 비교하면서 자신만만했던 README를 보는 것 같습니다.

ELK와 비교해서 signoz에선 어떤 기술 스택을 사용하고 있는지 한 번 보겠습니다.

### ElasticSearch → Clickhouse

수많은 로그와 메트릭들이 파이프라인을 타고 데이터가 적재될텐데, 이를 저장할 저장소(DB)가 필요합니다.

ELK에선 `ElasticSearch`가 그 역할을 해주고 있었다면, signoz에선 `clickhouse`라는 DB를 사용합니다.

`clickhouse`는 다른 DB와 다르게 컬럼지향 DBMS인데요, 여기선 자세히 다루지 않겠습니다.

데이터를 수집할 때 50%나 낮은 리소스 요구사항을 벤치마크로 확인했다고 하네요.

- https://signoz.io/blog/logs-performance-benchmark/?utm_source=github-readme&utm_medium=logs-benchmark

### Logstash → OpenTelemtry

애플리케이션에서 나오는 메트릭, 수많은 로그들을 누군가는 수집(collect)해야 하는데요.

ELK에선 `Logstash`(혹은 beat시리즈)가 그 역할을 해주고 있었다면, signoz에선 `opentelemetry`를 사용합니다.

![image](https://user-images.githubusercontent.com/26597702/277146744-071a1b5b-9311-4a76-b1f7-2053a6a7b31a.png)

위 그림의 `OTeL Collector`가 그 역할을 하는데 다른 collector와 다르게 데이터를 저장하거나 보여주진 않습니다.

오직 약간의 가공과 전송만 담당하는데요. 그 이유는 opentelemetry의 이념 때문인데, 데이터의 통계, 시각화 같은 기능들은 의도적으로 모니터링 벤더에게 위임하기 때문입니다.

참고: https://jennifersoft.com/ko/blog/tech/opentelemetry

### Kibana → signoz frontend

kibana의 역할을 하는 건 signoz 자체적으로 만든 frontend를 사용합니다.

생각보다 UI가 이쁘고 괜찮아요. kibana 만큼 다양한 통계나 시각화를 지원하진 않지만, 트러블슈팅 로그 추적엔 최고입니다.

## signoz 설치해보기

### signoz 설치 (with docker-compose)

```shell
git clone -b main https://github.com/SigNoz/signoz.git
cd signoz/deploy/
./install.sh
```

### 처음 접속시 회원가입 (최초 회원가입은 admin이 됨)

<img width="896" alt="image" src="https://user-images.githubusercontent.com/26597702/275214896-7392ef86-a23f-40c4-900e-6f6f0e0c8cc6.png">

### opentelemetry javaagent 설치

opentelemtry는 우리의 java 코드를 전혀 건드리지 않고 로그, 메트릭 수집을 할 수 있습니다.

바로 `javaagent`를 이용하는 건데, `javaagnet`는 `main` 메서드를 가로채 여러 동작을 할 수도 있고, 실행시간에 동적으로 bytecode를 조작할 수도 있습니다.

javaagent를 먼저 다운받아주고,

```shell
wget https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar
```

아래와 같이 -D옵션만 줘서 jar를 띄우면 끝입니다.

```shell
java -javaagent:/path/opentelemetry-javaagent.jar \
 -Dotel.exporter.otlp.endpoint=http://<IP of SigNoz>:4317 \
 -Dotel.resource.attributes=service.name=<service_name> \
 -jar target/*.jar
```

다음 포스팅에선 제대로 한 번 signoz를 사용해보고 어떤 장점이 있는지 알아보겠습니다.
