---
date: '2023-07-03'
title: '키퍼 홈페이지 리뉴얼 10 - 쿠키'
categories: ['keeper_homepage']
summary: '키퍼 홈페이지 리뉴얼2의 인증 방식인 JWT는 쿠키에 저장하는 방식을 사용하고 있었는데, 크롬의 쿠키 보안 정책 때문에 희한한 이슈를 맞게 된다.'
thumbnail: './thumbnail/cookie.png'
---

### 쿠키?

쿠키란 인터넷 웹사이트에 접속할 때 웹 사이트가 있는 서버에 의해 사용자의 컴퓨터에 저장되는 정보를 뜻한다.

-나무위키-

## 문제 상황

키퍼 홈페이지 리뉴얼2의 인증 방식인 JWT는 쿠키에 저장하는 방식을 사용하고 있었는데, 크롬의 쿠키 보안 정책 때문에 희한한 이슈를 맞게 된다.

> **개발 환경**
프론트: localhost
백엔드: localhost
> 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/97814051-6778-46ec-b45f-dda6701435cf/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4fabf702-64e0-484a-aeab-87b3c3d9b330/Untitled.png)

위에서 보는바와 같이 로그인을 시도하면 `Set-Cookie`헤더로 JWT가 전달되고 `accessToken`, `refreshToken`이라는 이름으로 쿠키가 저장된다.

하지만 개발환경을 아래와 같이 바꾸면 쿠키가 저장이 안되는 버그가 있었다.

> **개발 환경**
프론트: localhost
백엔드: [dev.keeper.or.kr](http://dev.keeper.or.kr) (키퍼 dev 서버)
> 

![분명히 accessToken과 refreshToken이 백엔드로부터 도착은 했다. 그런데…](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/46ae87a8-c943-4e9c-af75-d49252cb8688/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-07-02_21.41.15.png)

분명히 accessToken과 refreshToken이 백엔드로부터 도착은 했다. 그런데…

![accessToken과 refreshToken이 쿠키에 없다..!](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ab0d27dc-b7f3-4fd9-b861-c279c40bf701/Untitled.png)

accessToken과 refreshToken이 쿠키에 없다..!

쿠키에 토큰이 없었다. 분명히 백엔드로부터 토큰값이 도착은 했는데 프론트에서 저장이 안된 것이다.

첫 번째 사진에서 `Set-Cookie`의 노란 경고 이모지가 눈에 거슬린다. 한 번 살펴보자.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0e18e358-c83b-42f6-9d0e-423a3df13f6f/Untitled.png)

`Set-Cookie` 헤더가 `SameSite`에서 오지 않았기 때문에 블락 했다는 내용이다.

그리고 블락을 고치고 싶으면 `SameSite=None` 으로 쿠키를 보내면 된다고 얘기까지 해준다.

### SameSite 쿠키

기본적으로 CSRF를 막기 위해 추가된 정책이다.

쿠키는 동일한 도메인의 쿠키가 아니더라도 요청을 보낼 때 일단 전부 보내는데, 이것 때문에 보안에 문제가 생길 수 있어서 쿠키의 접근 권한을 `SameSite`로 제한한 것이다.

`SameSite`는 아래와 같이 3가지 방식을 가진다.

- Strict → 같은 도메인일때만 해당 쿠키를 전송
- Lax(default) → 같은 도메인이거나 a 태그로 접근시에만 쿠키를 전송한다.
- None → 다 사용한다.

원래 크롬의 기본 정책은 None이었는데, 20년도부터 Lax가 default로 바뀌었다.

> [대충 20년도에 크롬이 쿠키 보안 정책을 변경하면서 다들 바빴다는 글](https://yceffort.kr/2020/01/chrome-cookie-same-site-secure)
> 

### 키퍼 인증 방식의 문제점

그래서 다시 문제상황으로 돌아가면, 프론트와 백엔드의 도메인이 달랐던 것이 문제였다.

로컬-로컬, dev-dev면 상관없지만 프론트에서 백엔드 서버를 열 일이 없었기 때문에 로컬(프론트)-dev(백엔드)로 개발하던 환경이 문제였었다.

이를 해결하기 위해 방법을 3가지 정도 생각했는데,

1. **크롬에서 말해주는대로 None 방식 사용**
2. 백엔드를 도커로 말아서 프론트한테 개발할 때 도커 띄우라고 말해주기
3. JWT전달 방식을 쿠키방식 대신 헤더에 직접 넣는 방식으로 변경하기

결국 1번을 선택했다.

2번은 도커로 마는것 자체는 공수가 별로 안들지만, dev서버에 admin계정이나 기타 작업하던 내용들이 많기 때문에 프론트 로컬에서 QA도 바로바로 할 수 있는 장점이 있어서 하지 않았고,

3번은 견적을 내보니 **백엔드 작업량**이 너무 많았기 때문이다.

1번을 선택했을 때 예상되는 문제는 **크롬이 정책을 바꾼 이유이기도 한 CSRF의 위협**인데, 이를 위해서 **prod에선 Strict 방식을 사용하도록** 해줘야 했다.

### 쿠키 SameSite=None으로 설정

크롬에서 권장한대로 SameSite=None으로 주고 쿠키를 전달해보았다.

![중간에 `.sameSite("None")` 부분이 바뀐 부분이다.](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8e45ec43-04cc-48a4-bc56-48c347b3f0e0/Untitled.png)

중간에 `.sameSite("None")` 부분이 바뀐 부분이다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d6cbe75f-10a4-4c4f-ac22-342bccec03dd/Untitled.png)

이번엔 잘되나 싶었는데 여전히 노랑 뱃지가 떠있어서 살펴봤다.

이전과 조금 다른 문구였는데, `SameSite=None` 옵션은 `Secure`랑 같이 쓰여야 한다고 한다. 그런데 키퍼 dev사이트는 HTTPS가 아니었기 때문에 인프라의 전설(legend)님에게 부탁드렸다.

![주말이었음에도 불구하고 바로 해준다는 그저 legend](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/02b13395-a344-45a5-9f93-7817eaa1a5ed/KakaoTalk_Snapshot_20230702_221924.png)

주말이었음에도 불구하고 바로 해준다는 그저 legend

순식간에 dev서버에 SSL이 달렸고 바로 이어서 작업을 할 수 있게 됐다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5ec0052c-1594-4e3d-a794-eefd626cfb84/Untitled.png)

놀랍게도 또 떠버린 크롬의 노랑뱃지…

이번에 문제는 백엔드는 SSL이 달렸는데 프론트가 http라 생긴 문제였다.

얼른 `.env` 파일에 `HTTPS=true` 옵션으로 https를 달아주고, 다시 시도해보았다.

![물론 크롬의 빨강뱃지가 반겨줬다.](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2fa3384b-9384-4b38-bace-d5803bac0137/Untitled.png)

물론 크롬의 빨강뱃지가 반겨줬다.

> **현재까지 개발환경**
프론트: local(https)
백: dev(https)
> 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4da44a44-f1cf-4f29-927b-1935c5f182a5/Untitled.png)

드디어 노란 뱃지가 뜨지 않는다!

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e96df936-56e5-4815-99b6-9c62055be2cd/Untitled.png)

그런데 개발자도구의 쿠키 목록에 세팅해놓은 쿠키가 없다..!

그런데 다시 한 번 요청을 보냈을 땐 `Request Headers`에 쿠키가 잘 들어가서 보내지는걸로 보인다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c223ee61-cf80-405e-bb46-fab6811d7491/Untitled.png)

**왜 쿠키가 개발자 도구에 안보이는진 모르겠지만 어쨋건 해결…!**

> **************************************************************사실 여기서 바로 해결된 건 아니고 3일간의 SSL CORS 고군분투가 있었다…
RIP. 전설**************************************************************
>